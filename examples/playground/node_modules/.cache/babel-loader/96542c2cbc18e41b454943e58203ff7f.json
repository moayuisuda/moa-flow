{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getBindingDictionary = exports.createMockRequest = exports.plan = void 0;\n\nvar binding_count_1 = require(\"../bindings/binding_count\");\n\nvar ERROR_MSGS = require(\"../constants/error_msgs\");\n\nvar literal_types_1 = require(\"../constants/literal_types\");\n\nvar METADATA_KEY = require(\"../constants/metadata_keys\");\n\nvar exceptions_1 = require(\"../utils/exceptions\");\n\nvar serialization_1 = require(\"../utils/serialization\");\n\nvar context_1 = require(\"./context\");\n\nvar metadata_1 = require(\"./metadata\");\n\nvar plan_1 = require(\"./plan\");\n\nvar reflection_utils_1 = require(\"./reflection_utils\");\n\nvar request_1 = require(\"./request\");\n\nvar target_1 = require(\"./target\");\n\nfunction getBindingDictionary(cntnr) {\n  return cntnr._bindingDictionary;\n}\n\nexports.getBindingDictionary = getBindingDictionary;\n\nfunction _createTarget(isMultiInject, targetType, serviceIdentifier, name, key, value) {\n  var metadataKey = isMultiInject ? METADATA_KEY.MULTI_INJECT_TAG : METADATA_KEY.INJECT_TAG;\n  var injectMetadata = new metadata_1.Metadata(metadataKey, serviceIdentifier);\n  var target = new target_1.Target(targetType, name, serviceIdentifier, injectMetadata);\n\n  if (key !== undefined) {\n    var tagMetadata = new metadata_1.Metadata(key, value);\n    target.metadata.push(tagMetadata);\n  }\n\n  return target;\n}\n\nfunction _getActiveBindings(metadataReader, avoidConstraints, context, parentRequest, target) {\n  var bindings = getBindings(context.container, target.serviceIdentifier);\n  var activeBindings = [];\n\n  if (bindings.length === binding_count_1.BindingCount.NoBindingsAvailable && context.container.options.autoBindInjectable && typeof target.serviceIdentifier === \"function\" && metadataReader.getConstructorMetadata(target.serviceIdentifier).compilerGeneratedMetadata) {\n    context.container.bind(target.serviceIdentifier).toSelf();\n    bindings = getBindings(context.container, target.serviceIdentifier);\n  }\n\n  if (!avoidConstraints) {\n    activeBindings = bindings.filter(function (binding) {\n      var request = new request_1.Request(binding.serviceIdentifier, context, parentRequest, binding, target);\n      return binding.constraint(request);\n    });\n  } else {\n    activeBindings = bindings;\n  }\n\n  _validateActiveBindingCount(target.serviceIdentifier, activeBindings, target, context.container);\n\n  return activeBindings;\n}\n\nfunction _validateActiveBindingCount(serviceIdentifier, bindings, target, container) {\n  switch (bindings.length) {\n    case binding_count_1.BindingCount.NoBindingsAvailable:\n      if (target.isOptional()) {\n        return bindings;\n      } else {\n        var serviceIdentifierString = serialization_1.getServiceIdentifierAsString(serviceIdentifier);\n        var msg = ERROR_MSGS.NOT_REGISTERED;\n        msg += serialization_1.listMetadataForTarget(serviceIdentifierString, target);\n        msg += serialization_1.listRegisteredBindingsForServiceIdentifier(container, serviceIdentifierString, getBindings);\n        throw new Error(msg);\n      }\n\n    case binding_count_1.BindingCount.OnlyOneBindingAvailable:\n      if (!target.isArray()) {\n        return bindings;\n      }\n\n    case binding_count_1.BindingCount.MultipleBindingsAvailable:\n    default:\n      if (!target.isArray()) {\n        var serviceIdentifierString = serialization_1.getServiceIdentifierAsString(serviceIdentifier);\n        var msg = ERROR_MSGS.AMBIGUOUS_MATCH + \" \" + serviceIdentifierString;\n        msg += serialization_1.listRegisteredBindingsForServiceIdentifier(container, serviceIdentifierString, getBindings);\n        throw new Error(msg);\n      } else {\n        return bindings;\n      }\n\n  }\n}\n\nfunction _createSubRequests(metadataReader, avoidConstraints, serviceIdentifier, context, parentRequest, target) {\n  var activeBindings;\n  var childRequest;\n\n  if (parentRequest === null) {\n    activeBindings = _getActiveBindings(metadataReader, avoidConstraints, context, null, target);\n    childRequest = new request_1.Request(serviceIdentifier, context, null, activeBindings, target);\n    var thePlan = new plan_1.Plan(context, childRequest);\n    context.addPlan(thePlan);\n  } else {\n    activeBindings = _getActiveBindings(metadataReader, avoidConstraints, context, parentRequest, target);\n    childRequest = parentRequest.addChildRequest(target.serviceIdentifier, activeBindings, target);\n  }\n\n  activeBindings.forEach(function (binding) {\n    var subChildRequest = null;\n\n    if (target.isArray()) {\n      subChildRequest = childRequest.addChildRequest(binding.serviceIdentifier, binding, target);\n    } else {\n      if (binding.cache) {\n        return;\n      }\n\n      subChildRequest = childRequest;\n    }\n\n    if (binding.type === literal_types_1.BindingTypeEnum.Instance && binding.implementationType !== null) {\n      var dependencies = reflection_utils_1.getDependencies(metadataReader, binding.implementationType);\n\n      if (!context.container.options.skipBaseClassChecks) {\n        var baseClassDependencyCount = reflection_utils_1.getBaseClassDependencyCount(metadataReader, binding.implementationType);\n\n        if (dependencies.length < baseClassDependencyCount) {\n          var error = ERROR_MSGS.ARGUMENTS_LENGTH_MISMATCH(reflection_utils_1.getFunctionName(binding.implementationType));\n          throw new Error(error);\n        }\n      }\n\n      dependencies.forEach(function (dependency) {\n        _createSubRequests(metadataReader, false, dependency.serviceIdentifier, context, subChildRequest, dependency);\n      });\n    }\n  });\n}\n\nfunction getBindings(container, serviceIdentifier) {\n  var bindings = [];\n  var bindingDictionary = getBindingDictionary(container);\n\n  if (bindingDictionary.hasKey(serviceIdentifier)) {\n    bindings = bindingDictionary.get(serviceIdentifier);\n  } else if (container.parent !== null) {\n    bindings = getBindings(container.parent, serviceIdentifier);\n  }\n\n  return bindings;\n}\n\nfunction plan(metadataReader, container, isMultiInject, targetType, serviceIdentifier, key, value, avoidConstraints) {\n  if (avoidConstraints === void 0) {\n    avoidConstraints = false;\n  }\n\n  var context = new context_1.Context(container);\n\n  var target = _createTarget(isMultiInject, targetType, serviceIdentifier, \"\", key, value);\n\n  try {\n    _createSubRequests(metadataReader, avoidConstraints, serviceIdentifier, context, null, target);\n\n    return context;\n  } catch (error) {\n    if (exceptions_1.isStackOverflowExeption(error)) {\n      if (context.plan) {\n        serialization_1.circularDependencyToException(context.plan.rootRequest);\n      }\n    }\n\n    throw error;\n  }\n}\n\nexports.plan = plan;\n\nfunction createMockRequest(container, serviceIdentifier, key, value) {\n  var target = new target_1.Target(literal_types_1.TargetTypeEnum.Variable, \"\", serviceIdentifier, new metadata_1.Metadata(key, value));\n  var context = new context_1.Context(container);\n  var request = new request_1.Request(serviceIdentifier, context, null, [], target);\n  return request;\n}\n\nexports.createMockRequest = createMockRequest;","map":{"version":3,"mappings":"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","names":["getBindingDictionary","cntnr","_bindingDictionary","exports","_createTarget","isMultiInject","targetType","serviceIdentifier","name","key","value","metadataKey","METADATA_KEY","MULTI_INJECT_TAG","INJECT_TAG","injectMetadata","metadata_1","target","target_1","undefined","tagMetadata","metadata","push","_getActiveBindings","metadataReader","avoidConstraints","context","parentRequest","bindings","getBindings","container","activeBindings","length","binding_count_1","NoBindingsAvailable","options","autoBindInjectable","getConstructorMetadata","compilerGeneratedMetadata","bind","toSelf","filter","binding","request","request_1","constraint","_validateActiveBindingCount","isOptional","serviceIdentifierString","serialization_1","msg","ERROR_MSGS","NOT_REGISTERED","Error","OnlyOneBindingAvailable","isArray","MultipleBindingsAvailable","AMBIGUOUS_MATCH","_createSubRequests","childRequest","thePlan","plan_1","addPlan","addChildRequest","forEach","subChildRequest","cache","type","literal_types_1","Instance","implementationType","dependencies","reflection_utils_1","skipBaseClassChecks","baseClassDependencyCount","error","ARGUMENTS_LENGTH_MISMATCH","dependency","bindingDictionary","hasKey","get","parent","plan","context_1","exceptions_1","rootRequest","createMockRequest","Variable"],"sources":["../../src/planning/planner.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}