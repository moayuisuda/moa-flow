{"ast":null,"code":"import { __extends, __assign, __decorate } from './node_modules/tslib/tslib.es6.js';\nimport { Group, Circle, Canvas as Canvas$1 } from '@antv/react-g';\nimport LinkingEdge from './cells/LinkingEdge.js';\nimport React, { useContext, useState, useEffect, createRef } from 'react';\nimport { FlowModel } from './Model.js';\nimport { Renderer } from '@antv/g-canvas';\nimport { observer } from 'mobx-react';\nimport { computed } from 'mobx';\nimport { FlowContext } from './Context.js';\nimport { registComponents } from './utils/registComponents.js';\nimport SelectBoundsRect from './scaffold/SelectBoundsRect.js';\nimport { initClearState, initLink, initDrag, initSelect, initScale, initMultiSelect, initHotKeys } from './events.js';\nimport { STAGE_ID } from './constants.js';\nimport { color } from './theme/style.js';\nimport { getCanvas } from './utils/getElement.js';\nimport { getRightClickPanel } from './components/RightClickPanel/index.js';\nvar renderer = new Renderer();\n\nvar renderComponent = function (cellData, model) {\n  return React.createElement(model.componentsMap.get(cellData.component) || Group, {\n    data: cellData,\n    key: cellData.id\n  });\n};\n\nvar Dots = observer(function () {\n  var model = useContext(FlowContext); // const EXTRA = model.grid as number;\n\n  var EXTRA = 0;\n\n  var _dots = computed(function () {\n    var re = []; // @TODO\n\n    for (var i = -EXTRA; i <= model.height() + EXTRA; i += model.grid) {\n      for (var j = -EXTRA; j <= model.width() + EXTRA; j += model.grid) {\n        re.push({\n          x: j,\n          y: i\n        });\n      }\n    }\n\n    return re;\n  }).get();\n\n  return React.createElement(Group, null, _dots.map(function (dot) {\n    return React.createElement(Circle, {\n      x: dot.x,\n      y: dot.y,\n      r: 1,\n      fill: color.deepGrey\n    });\n  }));\n});\n\nvar Grid =\n/** @class */\nfunction (_super) {\n  __extends(Grid, _super);\n\n  function Grid(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.gridRef = React.createRef();\n    return _this;\n  }\n\n  Grid.prototype.render = function () {\n    var _this = this;\n\n    var grid = this.context.grid;\n\n    var _gridPos = computed(function () {\n      return {\n        x: -Math.round(_this.context.x() / _this.context.scale() / grid) * grid,\n        y: -Math.round(_this.context.y() / _this.context.scale() / grid) * grid\n      };\n    }).get();\n\n    return React.createElement(Group, __assign({}, _gridPos, {\n      zIndex: 0,\n      ref: this.gridRef,\n      visibility: this.context.grid && this.context.scale() >= 1 ? \"visible\" : \"hidden\"\n    }), React.createElement(Dots, null));\n  };\n\n  Grid.contextType = FlowContext;\n  Grid = __decorate([observer], Grid);\n  return Grid;\n}(React.Component);\n\nvar Edges = observer(function () {\n  var context = useContext(FlowContext);\n\n  var _a = useState(0);\n\n  _a[0];\n  var setSecondRefresh = _a[1];\n  useEffect(function () {\n    setSecondRefresh(1);\n  }, []);\n  var edgesData = context.canvasData.cells.filter(function (cellData) {\n    return cellData.cellType === \"edge\";\n  });\n  return React.createElement(Group, {\n    zIndex: 1\n  }, edgesData.map(function (cellData) {\n    return renderComponent(cellData, context);\n  }));\n});\nvar Nodes = observer(function () {\n  var context = useContext(FlowContext);\n  var nodesData = context.canvasData.cells.filter(function (cellData) {\n    return cellData.cellType !== \"edge\";\n  });\n  return React.createElement(Group, {\n    zIndex: 2\n  }, nodesData.slice(0, nodesData.length).map(function (cellData) {\n    return renderComponent(cellData, context);\n  }));\n});\nvar InteractTop = observer(function () {\n  var context = useContext(FlowContext);\n  return React.createElement(Group, {\n    zIndex: 3\n  }, React.createElement(LinkingEdge, {\n    data: context.buffer.link\n  }), React.createElement(SelectBoundsRect, null));\n});\n\nvar Flow =\n/** @class */\nfunction (_super) {\n  __extends(Flow, _super);\n\n  function Flow(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.flowModel = new FlowModel(props.onEvent);\n    _this.props.canvasData && _this.flowModel.setCanvasData(_this.props.canvasData);\n    _this.props.grid && _this.flowModel.setGrid(_this.props.grid);\n\n    if (_this.props.width && _this.props.height) {\n      _this.flowModel.setSize(_this.props.width, _this.props.height);\n    }\n\n    props.modelRef && (props.modelRef.current = _this.flowModel);\n    props.onLoad && props.onLoad(_this.flowModel);\n    var refs = _this.flowModel.refs;\n    _this.stageRef = refs.stageRef = createRef();\n    registComponents(_this.flowModel);\n    return _this;\n  }\n\n  Flow.prototype.componentDidMount = function () {\n    var model = this.flowModel;\n    var stage = this.stageRef.current;\n    var _a = this.props,\n        _b = _a.zoom,\n        zoom = _b === void 0 ? true : _b,\n        _c = _a.multiSelect,\n        multiSelect = _c === void 0 ? false : _c;\n    initClearState(model, stage);\n    initLink(model, stage);\n    initDrag(model, stage);\n    initSelect(model);\n    zoom && initScale(model, stage);\n    multiSelect && initMultiSelect(model, stage);\n    initHotKeys(model, stage);\n    initHotKeys(model, stage);\n  };\n\n  Flow.prototype.render = function () {\n    var model = this.flowModel;\n    return React.createElement(\"div\", {\n      style: {\n        position: \"relative\",\n        display: \"inline-block\"\n      },\n      id: STAGE_ID\n    }, React.createElement(FlowContext.Provider, {\n      value: model\n    }, getRightClickPanel(this.props.children), React.createElement(Canvas$1, {\n      renderer: renderer,\n      ref: this.stageRef,\n      width: model.width(),\n      height: model.height()\n    }, React.createElement(Group, {\n      transform: \"scale(\".concat(model.scale(), \", \").concat(model.scale(), \")\"),\n      x: model.x(),\n      y: model.y()\n    }, React.createElement(FlowContext.Provider, {\n      value: model\n    }, this.props.grid && React.createElement(Grid, null), getCanvas(this.props.children))))));\n  };\n\n  Flow = __decorate([observer], Flow);\n  return Flow;\n}(React.Component);\n\nvar Canvas = function () {\n  return React.createElement(React.Fragment, null, React.createElement(Nodes, null), React.createElement(Edges, null), React.createElement(InteractTop, null));\n};\n\nexport { Canvas, Flow as default };","map":{"version":3,"sources":["/Users/dennis.zhang/Desktop/其它代码库/moa-flow/packages/flow/lib/Flow.js"],"names":["__extends","__assign","__decorate","Group","Circle","Canvas","Canvas$1","LinkingEdge","React","useContext","useState","useEffect","createRef","FlowModel","Renderer","observer","computed","FlowContext","registComponents","SelectBoundsRect","initClearState","initLink","initDrag","initSelect","initScale","initMultiSelect","initHotKeys","STAGE_ID","color","getCanvas","getRightClickPanel","renderer","renderComponent","cellData","model","createElement","componentsMap","get","component","data","key","id","Dots","EXTRA","_dots","re","i","height","grid","j","width","push","x","y","map","dot","r","fill","deepGrey","Grid","_super","props","_this","call","gridRef","prototype","render","context","_gridPos","Math","round","scale","zIndex","ref","visibility","contextType","Component","Edges","_a","setSecondRefresh","edgesData","canvasData","cells","filter","cellType","Nodes","nodesData","slice","length","InteractTop","buffer","link","Flow","flowModel","onEvent","setCanvasData","setGrid","setSize","modelRef","current","onLoad","refs","stageRef","componentDidMount","stage","_b","zoom","_c","multiSelect","style","position","display","Provider","value","children","transform","concat","Fragment","default"],"mappings":"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","sourcesContent":["import { __extends, __assign, __decorate } from './node_modules/tslib/tslib.es6.js';\nimport { Group, Circle, Canvas as Canvas$1 } from '@antv/react-g';\nimport LinkingEdge from './cells/LinkingEdge.js';\nimport React, { useContext, useState, useEffect, createRef } from 'react';\nimport { FlowModel } from './Model.js';\nimport { Renderer } from '@antv/g-canvas';\nimport { observer } from 'mobx-react';\nimport { computed } from 'mobx';\nimport { FlowContext } from './Context.js';\nimport { registComponents } from './utils/registComponents.js';\nimport SelectBoundsRect from './scaffold/SelectBoundsRect.js';\nimport { initClearState, initLink, initDrag, initSelect, initScale, initMultiSelect, initHotKeys } from './events.js';\nimport { STAGE_ID } from './constants.js';\nimport { color } from './theme/style.js';\nimport { getCanvas } from './utils/getElement.js';\nimport { getRightClickPanel } from './components/RightClickPanel/index.js';\n\nvar renderer = new Renderer();\nvar renderComponent = function (cellData, model) {\n    return React.createElement(model.componentsMap.get(cellData.component) || Group, {\n        data: cellData,\n        key: cellData.id,\n    });\n};\nvar Dots = observer(function () {\n    var model = useContext(FlowContext);\n    // const EXTRA = model.grid as number;\n    var EXTRA = 0;\n    var _dots = computed(function () {\n        var re = [];\n        // @TODO\n        for (var i = -EXTRA; i <= model.height() + EXTRA; i += model.grid) {\n            for (var j = -EXTRA; j <= model.width() + EXTRA; j += model.grid) {\n                re.push({\n                    x: j,\n                    y: i,\n                });\n            }\n        }\n        return re;\n    }).get();\n    return (React.createElement(Group, null, _dots.map(function (dot) {\n        return React.createElement(Circle, { x: dot.x, y: dot.y, r: 1, fill: color.deepGrey });\n    })));\n});\nvar Grid = /** @class */ (function (_super) {\n    __extends(Grid, _super);\n    function Grid(props) {\n        var _this = _super.call(this, props) || this;\n        _this.gridRef = React.createRef();\n        return _this;\n    }\n    Grid.prototype.render = function () {\n        var _this = this;\n        var grid = this.context.grid;\n        var _gridPos = computed(function () {\n            return {\n                x: -Math.round(_this.context.x() / _this.context.scale() / grid) * grid,\n                y: -Math.round(_this.context.y() / _this.context.scale() / grid) * grid,\n            };\n        }).get();\n        return (React.createElement(Group, __assign({}, _gridPos, { zIndex: 0, ref: this.gridRef, visibility: this.context.grid && this.context.scale() >= 1 ? \"visible\" : \"hidden\" }),\n            React.createElement(Dots, null)));\n    };\n    Grid.contextType = FlowContext;\n    Grid = __decorate([\n        observer\n    ], Grid);\n    return Grid;\n}(React.Component));\nvar Edges = observer(function () {\n    var context = useContext(FlowContext);\n    var _a = useState(0); _a[0]; var setSecondRefresh = _a[1];\n    useEffect(function () {\n        setSecondRefresh(1);\n    }, []);\n    var edgesData = context.canvasData.cells.filter(function (cellData) { return cellData.cellType === \"edge\"; });\n    return (React.createElement(Group, { zIndex: 1 }, edgesData.map(function (cellData) {\n        return renderComponent(cellData, context);\n    })));\n});\nvar Nodes = observer(function () {\n    var context = useContext(FlowContext);\n    var nodesData = context.canvasData.cells.filter(function (cellData) {\n        return cellData.cellType !== \"edge\";\n    });\n    return (React.createElement(Group, { zIndex: 2 }, nodesData.slice(0, nodesData.length).map(function (cellData) {\n        return renderComponent(cellData, context);\n    })));\n});\nvar InteractTop = observer(function () {\n    var context = useContext(FlowContext);\n    return (React.createElement(Group, { zIndex: 3 },\n        React.createElement(LinkingEdge, { data: context.buffer.link }),\n        React.createElement(SelectBoundsRect, null)));\n});\nvar Flow = /** @class */ (function (_super) {\n    __extends(Flow, _super);\n    function Flow(props) {\n        var _this = _super.call(this, props) || this;\n        _this.flowModel = new FlowModel(props.onEvent);\n        _this.props.canvasData &&\n            _this.flowModel.setCanvasData(_this.props.canvasData);\n        _this.props.grid && _this.flowModel.setGrid(_this.props.grid);\n        if (_this.props.width && _this.props.height) {\n            _this.flowModel.setSize(_this.props.width, _this.props.height);\n        }\n        props.modelRef && (props.modelRef.current = _this.flowModel);\n        props.onLoad && props.onLoad(_this.flowModel);\n        var refs = _this.flowModel.refs;\n        _this.stageRef = refs.stageRef = createRef();\n        registComponents(_this.flowModel);\n        return _this;\n    }\n    Flow.prototype.componentDidMount = function () {\n        var model = this.flowModel;\n        var stage = this.stageRef.current;\n        var _a = this.props, _b = _a.zoom, zoom = _b === void 0 ? true : _b, _c = _a.multiSelect, multiSelect = _c === void 0 ? false : _c;\n        initClearState(model, stage);\n        initLink(model, stage);\n        initDrag(model, stage);\n        initSelect(model);\n        zoom && initScale(model, stage);\n        multiSelect && initMultiSelect(model, stage);\n        initHotKeys(model, stage);\n        initHotKeys(model, stage);\n    };\n    Flow.prototype.render = function () {\n        var model = this.flowModel;\n        return (React.createElement(\"div\", { style: {\n                position: \"relative\",\n                display: \"inline-block\",\n            }, id: STAGE_ID },\n            React.createElement(FlowContext.Provider, { value: model },\n                getRightClickPanel(this.props.children),\n                React.createElement(Canvas$1, { renderer: renderer, ref: this.stageRef, width: model.width(), height: model.height() },\n                    React.createElement(Group, { transform: \"scale(\".concat(model.scale(), \", \").concat(model.scale(), \")\"), x: model.x(), y: model.y() },\n                        React.createElement(FlowContext.Provider, { value: model },\n                            this.props.grid && React.createElement(Grid, null),\n                            getCanvas(this.props.children)))))));\n    };\n    Flow = __decorate([\n        observer\n    ], Flow);\n    return Flow;\n}(React.Component));\nvar Canvas = function () {\n    return (React.createElement(React.Fragment, null,\n        React.createElement(Nodes, null),\n        React.createElement(Edges, null),\n        React.createElement(InteractTop, null)));\n};\n\nexport { Canvas, Flow as default };\n"]},"metadata":{},"sourceType":"module"}