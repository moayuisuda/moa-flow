{"ast":null,"code":"import { __extends, __spreadArray, __assign } from '../node_modules/tslib/tslib.es6.js';\nimport Cell from './Cell.js';\nimport { Group, Rect, Text } from '@antv/react-g';\nimport * as G from '@antv/g';\nimport Interactor from '../scaffold/Interacotr.js';\nimport React from 'react';\nimport { isVector2d } from '../utils/util.js';\nimport { titleCase } from '../utils/string.js';\nimport { lineCenter } from '../utils/vector.js';\nimport Arrow from '../components/Arrow.js';\nvar TEXT_HEIGHT = 16;\nvar LABEL_PADDING = 4;\n\nvar Edge =\n/** @class */\nfunction (_super) {\n  __extends(Edge, _super);\n\n  function Edge(props, context) {\n    var _this = _super.call(this, props, context) || this;\n\n    _this.bazier = false;\n    _this.arrow = false;\n    _this.isMountEvents = false;\n\n    _this.formatVerticied = function (verticies) {\n      return verticies;\n    };\n\n    _this.getLinkPortsData = function () {\n      return {\n        source: isVector2d(_this.props.data.source) ? _this.props.data.source : _this.context.cellsDataMap.get(_this.props.data.source),\n        target: isVector2d(_this.props.data.target) ? _this.props.data.target : _this.context.cellsDataMap.get(_this.props.data.target)\n      };\n    };\n\n    _this.getAnchors = function () {\n      var data = _this.props.data;\n      var sourceAnchor;\n      var targetAnchor;\n      if (isVector2d(data.source)) sourceAnchor = data.source;else {\n        var sourceInstance = _this.context.cellsMap.get(data.source);\n\n        sourceAnchor = sourceInstance.anchor();\n      }\n      if (isVector2d(data.target)) targetAnchor = data.target;else {\n        var targetInstance = _this.context.cellsMap.get(data.target);\n\n        targetAnchor = targetInstance.anchor();\n      }\n      return {\n        source: sourceAnchor,\n        target: targetAnchor\n      };\n    };\n\n    _this.labelRef = React.createRef();\n    return _this;\n  }\n\n  Edge.prototype.lineStyle = function (_a) {\n    var isSelect = _a.isSelect;\n    var color = this.context.color;\n\n    if (isSelect) {\n      return {\n        stroke: color.active\n      };\n    } else return {};\n  };\n\n  Edge.prototype.getPoints = function () {\n    var routeResult = this.route(this.getVectors());\n    return this.vectorsToPoints(routeResult);\n  };\n\n  Edge.prototype.getVectors = function () {\n    var anchors = this.getAnchors();\n    var verticies = this.props.data.verticies || [];\n    return __spreadArray(__spreadArray([anchors.source], verticies, true), [anchors.target], false);\n  };\n\n  Edge.prototype.getLinkNodesData = function () {\n    var data = this.props.data;\n    var source;\n    var target;\n\n    if (!isVector2d(data.source)) {\n      var sourcePort = this.context.cellsDataMap.get(data.source);\n      source = this.context.cellsDataMap.get(sourcePort.host);\n    }\n\n    if (!isVector2d(data.target)) {\n      var targetPort = this.context.cellsDataMap.get(data.target);\n      target = this.context.cellsDataMap.get(targetPort.host);\n    }\n\n    return {\n      source: source,\n      target: target\n    };\n  }; // 这个方法暴露出去，可自定义路由\n\n\n  Edge.prototype.route = function (vectors) {\n    return vectors;\n  };\n\n  Edge.prototype.vectorsToPoints = function (vectors) {\n    var re = [];\n    vectors.forEach(function (vector) {\n      re.push([vector.x, vector.y]);\n    });\n    return re;\n  };\n\n  Edge.prototype.labelContent = function () {\n    var _a, _b;\n\n    var _c = this.context;\n    _c.color;\n    var stageRef = _c.refs.stageRef;\n    var text = this.labelFormatter(this.props.data.label);\n    if (!text) return React.createElement(React.Fragment, null);\n\n    var props = __assign({\n      text: text,\n      textBaseline: \"top\"\n    }, this.labelStyle());\n\n    var textInstance = new G.Text({\n      style: props\n    });\n    (_a = stageRef === null || stageRef === void 0 ? void 0 : stageRef.current) === null || _a === void 0 ? void 0 : _a.appendChild(textInstance);\n    var textBounds = textInstance.getBBox();\n    (_b = stageRef === null || stageRef === void 0 ? void 0 : stageRef.current) === null || _b === void 0 ? void 0 : _b.removeChild(textInstance);\n    return React.createElement(Group, {\n      x: -(textBounds.width + LABEL_PADDING) / 2,\n      y: -(TEXT_HEIGHT + LABEL_PADDING) / 2\n    }, React.createElement(Rect, {\n      width: textBounds.width + LABEL_PADDING * 2,\n      height: TEXT_HEIGHT + LABEL_PADDING * 2,\n      fill: \"white\"\n    }), React.createElement(Text, __assign({\n      x: LABEL_PADDING,\n      y: LABEL_PADDING\n    }, props)));\n  };\n\n  Edge.prototype.labelStyle = function () {\n    return {};\n  };\n\n  Edge.prototype.labelPosition = function () {\n    var points = this.getVectors().map(function (vector) {\n      return [vector.x, vector.y];\n    });\n    var lineLenthCenter = lineCenter(points);\n    return {\n      x: lineLenthCenter[0] || points[0][0],\n      y: lineLenthCenter[1] || points[0][1]\n    };\n  };\n\n  Edge.prototype.labelRender = function () {\n    var _this = this;\n\n    var text = this.labelFormatter(this.props.data.label);\n    return React.createElement(Group, __assign({\n      ref: function (label) {\n        if (_this.isMountEvents || !label) return;\n        [\"mouseenter\", \"mouseleave\", \"mousedown\", \"mouseup\", \"dblclick\", \"click\"].forEach(function (eventName) {\n          label.on(eventName, function (e) {\n            var instanceEventFn = _this[\"onLabel\".concat(titleCase(eventName))];\n\n            instanceEventFn && instanceEventFn.call(_this, e);\n\n            _this.context.sendEvent({\n              type: \"label:\".concat(eventName),\n              data: {\n                e: e,\n                cellData: _this.props.data,\n                cell: _this\n              }\n            });\n          });\n        });\n        _this.isMountEvents = true;\n      }\n    }, this.labelPosition()), text && this.labelContent());\n  };\n\n  Edge.prototype.labelFormatter = function (label) {\n    return label;\n  };\n\n  Edge.prototype.isLinking = function () {\n    return this.props.data.$state.isLinking;\n  };\n\n  Edge.prototype.getBazierPath = function () {\n    var _a = this.getAnchors(),\n        source = _a.source,\n        target = _a.target;\n\n    var LENGTH = (source.x - target.x) * 0.5;\n    return \"M\".concat(source.x, \",\").concat(source.y, \" \\n    C\").concat(source.x - LENGTH, \",\").concat(source.y, \" \").concat(target.x + LENGTH, \",\").concat(target.y, \" \\n    \").concat(target.x, \",\").concat(target.y);\n  };\n\n  Edge.prototype.edgeRender = function (_a) {\n    var points = _a.points;\n    _a.isLinking;\n    var color = this.context.color;\n\n    var lineProps = __assign({\n      lineCap: \"round\",\n      lineJoin: \"round\",\n      lineWidth: 3,\n      stroke: color.deepGrey\n    }, this.lineStyle({\n      isSelect: this.isSelect()\n    }));\n\n    var bazierProps = {\n      type: \"Path\",\n      path: this.getBazierPath()\n    };\n    var polyLineProps = {\n      type: \"Polyline\",\n      points: points\n    };\n    return React.createElement(Group, null, React.createElement(Arrow, __assign({}, this.bazier ? bazierProps : polyLineProps, {\n      points: points\n    }, lineProps, {\n      endHead: true\n    })));\n  };\n\n  Edge.prototype.content = function () {\n    return React.createElement(Interactor, {\n      id: this.props.data.id,\n      draggable: false\n    }, this.edgeRender({\n      points: this.getPoints(),\n      isLinking: this.isLinking()\n    }), this.labelRender(), this.lineExtra && this.lineExtra());\n  };\n\n  Edge.metaData = {\n    cellType: \"edge\"\n  };\n  return Edge;\n}(Cell);\n\nexport { Edge as default };","map":{"version":3,"sources":["/Users/dennis.zhang/Desktop/其它代码库/moa-flow/packages/flow/lib/cells/Edge.js"],"names":["__extends","__spreadArray","__assign","Cell","Group","Rect","Text","G","Interactor","React","isVector2d","titleCase","lineCenter","Arrow","TEXT_HEIGHT","LABEL_PADDING","Edge","_super","props","context","_this","call","bazier","arrow","isMountEvents","formatVerticied","verticies","getLinkPortsData","source","data","cellsDataMap","get","target","getAnchors","sourceAnchor","targetAnchor","sourceInstance","cellsMap","anchor","targetInstance","labelRef","createRef","prototype","lineStyle","_a","isSelect","color","stroke","active","getPoints","routeResult","route","getVectors","vectorsToPoints","anchors","getLinkNodesData","sourcePort","host","targetPort","vectors","re","forEach","vector","push","x","y","labelContent","_b","_c","stageRef","refs","text","labelFormatter","label","createElement","Fragment","textBaseline","labelStyle","textInstance","style","current","appendChild","textBounds","getBBox","removeChild","width","height","fill","labelPosition","points","map","lineLenthCenter","labelRender","ref","eventName","on","e","instanceEventFn","concat","sendEvent","type","cellData","cell","isLinking","$state","getBazierPath","LENGTH","edgeRender","lineProps","lineCap","lineJoin","lineWidth","deepGrey","bazierProps","path","polyLineProps","endHead","content","id","draggable","lineExtra","metaData","cellType","default"],"mappings":"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","sourcesContent":["import { __extends, __spreadArray, __assign } from '../node_modules/tslib/tslib.es6.js';\nimport Cell from './Cell.js';\nimport { Group, Rect, Text } from '@antv/react-g';\nimport * as G from '@antv/g';\nimport Interactor from '../scaffold/Interacotr.js';\nimport React from 'react';\nimport { isVector2d } from '../utils/util.js';\nimport { titleCase } from '../utils/string.js';\nimport { lineCenter } from '../utils/vector.js';\nimport Arrow from '../components/Arrow.js';\n\nvar TEXT_HEIGHT = 16;\nvar LABEL_PADDING = 4;\nvar Edge = /** @class */ (function (_super) {\n    __extends(Edge, _super);\n    function Edge(props, context) {\n        var _this = _super.call(this, props, context) || this;\n        _this.bazier = false;\n        _this.arrow = false;\n        _this.isMountEvents = false;\n        _this.formatVerticied = function (verticies) {\n            return verticies;\n        };\n        _this.getLinkPortsData = function () {\n            return {\n                source: isVector2d(_this.props.data.source)\n                    ? _this.props.data.source\n                    : _this.context.cellsDataMap.get(_this.props.data.source),\n                target: isVector2d(_this.props.data.target)\n                    ? _this.props.data.target\n                    : _this.context.cellsDataMap.get(_this.props.data.target),\n            };\n        };\n        _this.getAnchors = function () {\n            var data = _this.props.data;\n            var sourceAnchor;\n            var targetAnchor;\n            if (isVector2d(data.source))\n                sourceAnchor = data.source;\n            else {\n                var sourceInstance = _this.context.cellsMap.get(data.source);\n                sourceAnchor = sourceInstance.anchor();\n            }\n            if (isVector2d(data.target))\n                targetAnchor = data.target;\n            else {\n                var targetInstance = _this.context.cellsMap.get(data.target);\n                targetAnchor = targetInstance.anchor();\n            }\n            return {\n                source: sourceAnchor,\n                target: targetAnchor,\n            };\n        };\n        _this.labelRef = React.createRef();\n        return _this;\n    }\n    Edge.prototype.lineStyle = function (_a) {\n        var isSelect = _a.isSelect;\n        var color = this.context.color;\n        if (isSelect) {\n            return {\n                stroke: color.active,\n            };\n        }\n        else\n            return {};\n    };\n    Edge.prototype.getPoints = function () {\n        var routeResult = this.route(this.getVectors());\n        return this.vectorsToPoints(routeResult);\n    };\n    Edge.prototype.getVectors = function () {\n        var anchors = this.getAnchors();\n        var verticies = this.props.data.verticies || [];\n        return __spreadArray(__spreadArray([anchors.source], verticies, true), [anchors.target], false);\n    };\n    Edge.prototype.getLinkNodesData = function () {\n        var data = this.props.data;\n        var source;\n        var target;\n        if (!isVector2d(data.source)) {\n            var sourcePort = this.context.cellsDataMap.get(data.source);\n            source = this.context.cellsDataMap.get(sourcePort.host);\n        }\n        if (!isVector2d(data.target)) {\n            var targetPort = this.context.cellsDataMap.get(data.target);\n            target = this.context.cellsDataMap.get(targetPort.host);\n        }\n        return {\n            source: source,\n            target: target,\n        };\n    };\n    // 这个方法暴露出去，可自定义路由\n    Edge.prototype.route = function (vectors) {\n        return vectors;\n    };\n    Edge.prototype.vectorsToPoints = function (vectors) {\n        var re = [];\n        vectors.forEach(function (vector) {\n            re.push([vector.x, vector.y]);\n        });\n        return re;\n    };\n    Edge.prototype.labelContent = function () {\n        var _a, _b;\n        var _c = this.context; _c.color; var stageRef = _c.refs.stageRef;\n        var text = this.labelFormatter(this.props.data.label);\n        if (!text)\n            return React.createElement(React.Fragment, null);\n        var props = __assign({ text: text, textBaseline: \"top\" }, this.labelStyle());\n        var textInstance = new G.Text({\n            style: props,\n        });\n        (_a = stageRef === null || stageRef === void 0 ? void 0 : stageRef.current) === null || _a === void 0 ? void 0 : _a.appendChild(textInstance);\n        var textBounds = textInstance.getBBox();\n        (_b = stageRef === null || stageRef === void 0 ? void 0 : stageRef.current) === null || _b === void 0 ? void 0 : _b.removeChild(textInstance);\n        return (React.createElement(Group, { x: -(textBounds.width + LABEL_PADDING) / 2, y: -(TEXT_HEIGHT + LABEL_PADDING) / 2 },\n            React.createElement(Rect, { width: textBounds.width + LABEL_PADDING * 2, height: TEXT_HEIGHT + LABEL_PADDING * 2, fill: \"white\" }),\n            React.createElement(Text, __assign({ x: LABEL_PADDING, y: LABEL_PADDING }, props))));\n    };\n    Edge.prototype.labelStyle = function () {\n        return {};\n    };\n    Edge.prototype.labelPosition = function () {\n        var points = this.getVectors().map(function (vector) { return [vector.x, vector.y]; });\n        var lineLenthCenter = lineCenter(points);\n        return {\n            x: lineLenthCenter[0] || points[0][0],\n            y: lineLenthCenter[1] || points[0][1],\n        };\n    };\n    Edge.prototype.labelRender = function () {\n        var _this = this;\n        var text = this.labelFormatter(this.props.data.label);\n        return (React.createElement(Group, __assign({ ref: function (label) {\n                if (_this.isMountEvents || !label)\n                    return;\n                [\n                    \"mouseenter\",\n                    \"mouseleave\",\n                    \"mousedown\",\n                    \"mouseup\",\n                    \"dblclick\",\n                    \"click\",\n                ].forEach(function (eventName) {\n                    label.on(eventName, function (e) {\n                        var instanceEventFn = _this[\"onLabel\".concat(titleCase(eventName))];\n                        instanceEventFn && instanceEventFn.call(_this, e);\n                        _this.context.sendEvent({\n                            type: \"label:\".concat(eventName),\n                            data: {\n                                e: e,\n                                cellData: _this.props.data,\n                                cell: _this,\n                            },\n                        });\n                    });\n                });\n                _this.isMountEvents = true;\n            } }, this.labelPosition()), text && this.labelContent()));\n    };\n    Edge.prototype.labelFormatter = function (label) {\n        return label;\n    };\n    Edge.prototype.isLinking = function () {\n        return this.props.data.$state.isLinking;\n    };\n    Edge.prototype.getBazierPath = function () {\n        var _a = this.getAnchors(), source = _a.source, target = _a.target;\n        var LENGTH = (source.x - target.x) * 0.5;\n        return \"M\".concat(source.x, \",\").concat(source.y, \" \\n    C\").concat(source.x - LENGTH, \",\").concat(source.y, \" \").concat(target.x + LENGTH, \",\").concat(target.y, \" \\n    \").concat(target.x, \",\").concat(target.y);\n    };\n    Edge.prototype.edgeRender = function (_a) {\n        var points = _a.points; _a.isLinking;\n        var color = this.context.color;\n        var lineProps = __assign({ lineCap: \"round\", lineJoin: \"round\", lineWidth: 3, stroke: color.deepGrey }, this.lineStyle({ isSelect: this.isSelect() }));\n        var bazierProps = {\n            type: \"Path\",\n            path: this.getBazierPath(),\n        };\n        var polyLineProps = {\n            type: \"Polyline\",\n            points: points,\n        };\n        return (React.createElement(Group, null,\n            React.createElement(Arrow, __assign({}, (this.bazier ? bazierProps : polyLineProps), { points: points }, lineProps, { endHead: true }))));\n    };\n    Edge.prototype.content = function () {\n        return (React.createElement(Interactor, { id: this.props.data.id, draggable: false },\n            this.edgeRender({\n                points: this.getPoints(),\n                isLinking: this.isLinking(),\n            }),\n            this.labelRender(),\n            this.lineExtra && this.lineExtra()));\n    };\n    Edge.metaData = {\n        cellType: \"edge\",\n    };\n    return Edge;\n}(Cell));\n\nexport { Edge as default };\n"]},"metadata":{},"sourceType":"module"}