{"ast":null,"code":"import { __awaiter, __decorate, __extends, __generator, __metadata } from \"tslib\";\nimport { mat4, vec3 } from 'gl-matrix';\nimport { inject, singleton, postConstruct } from 'mana-syringe';\nimport { EventEmitter } from 'eventemitter3';\nimport { CanvasConfig } from '../types';\nimport { Element } from '../dom/Element';\nimport { Node } from '../dom/Node';\nimport { FederatedMouseEvent } from '../dom/FederatedMouseEvent';\nimport { FederatedPointerEvent } from '../dom/FederatedPointerEvent';\nimport { FederatedWheelEvent } from '../dom/FederatedWheelEvent';\nimport { RenderingContext } from './RenderingContext';\nimport { Point } from '../shapes';\nimport { ContextService } from './ContextService';\nvar PROPAGATION_LIMIT = 2048;\n\nvar EventService =\n/** @class */\nfunction (_super) {\n  __extends(EventService, _super);\n\n  function EventService() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.cursor = 'default';\n    _this.mappingTable = {};\n    _this.mappingState = {\n      trackingData: {}\n    };\n    _this.eventPool = new Map();\n\n    _this.onPointerDown = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var e, isRightButton, trackingData;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              this.dispatchEvent(e, 'pointerdown');\n\n              if (e.pointerType === 'touch') {\n                // only the\n                // if (e.isLast) {\n                this.dispatchEvent(e, 'touchstart'); // }\n              } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                isRightButton = e.button === 2;\n                this.dispatchEvent(e, isRightButton ? 'rightdown' : 'mousedown');\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              trackingData.pressTargetsByButton[from.button] = e.composedPath();\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerUp = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var now, e, isRightButton, trackingData, pressTarget, clickTarget, currentTarget, isRightButton, clickEvent, clickHistory;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              now = performance.now();\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              this.dispatchEvent(e, 'pointerup');\n\n              if (e.pointerType === 'touch') {\n                this.dispatchEvent(e, 'touchend');\n              } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                isRightButton = e.button === 2;\n                this.dispatchEvent(e, isRightButton ? 'rightup' : 'mouseup');\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              pressTarget = this.findMountedTarget(trackingData.pressTargetsByButton[from.button]);\n              clickTarget = pressTarget; // pointerupoutside only bubbles. It only bubbles upto the parent that doesn't contain\n              // the pointerup location.\n\n              if (pressTarget && !e.composedPath().includes(pressTarget)) {\n                currentTarget = pressTarget;\n\n                while (currentTarget && !e.composedPath().includes(currentTarget)) {\n                  e.currentTarget = currentTarget;\n                  this.notifyTarget(e, 'pointerupoutside');\n\n                  if (e.pointerType === 'touch') {\n                    this.notifyTarget(e, 'touchendoutside');\n                  } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                    isRightButton = e.button === 2;\n                    this.notifyTarget(e, isRightButton ? 'rightupoutside' : 'mouseupoutside');\n                  }\n\n                  if (Node.isNode(currentTarget)) {\n                    currentTarget = currentTarget.parentNode;\n                  }\n                }\n\n                delete trackingData.pressTargetsByButton[from.button]; // currentTarget is the most specific ancestor holding both the pointerdown and pointerup\n                // targets. That is - it's our click target!\n\n                clickTarget = currentTarget;\n              }\n\n              if (clickTarget) {\n                clickEvent = this.clonePointerEvent(e, 'click');\n                clickEvent.target = clickTarget;\n                clickEvent.path = [];\n\n                if (!trackingData.clicksByButton[from.button]) {\n                  trackingData.clicksByButton[from.button] = {\n                    clickCount: 0,\n                    target: clickEvent.target,\n                    timeStamp: now\n                  };\n                }\n\n                clickHistory = trackingData.clicksByButton[from.button];\n\n                if (clickHistory.target === clickEvent.target && now - clickHistory.timeStamp < 200) {\n                  ++clickHistory.clickCount;\n                } else {\n                  clickHistory.clickCount = 1;\n                }\n\n                clickHistory.target = clickEvent.target;\n                clickHistory.timeStamp = now;\n                clickEvent.detail = clickHistory.clickCount;\n\n                if (clickEvent.pointerType === 'mouse' || clickEvent.pointerType === 'touch') {\n                  this.dispatchEvent(clickEvent, 'click');\n                } else {\n                  this.dispatchEvent(clickEvent, 'pointertap');\n                }\n\n                this.freeEvent(clickEvent);\n              }\n\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerMove = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var e, isMouse, trackingData, outTarget, outType, outEvent, leaveEvent, overType, overEvent, overTargetAncestor, didPointerEnter, enterEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              isMouse = e.pointerType === 'mouse' || e.pointerType === 'pen';\n              trackingData = this.trackingData(from.pointerId);\n              outTarget = this.findMountedTarget(trackingData.overTargets);\n              if (!(trackingData.overTargets && outTarget !== e.target)) return [3\n              /*break*/\n              , 5];\n              outType = from.type === 'mousemove' ? 'mouseout' : 'pointerout';\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, outType, outTarget || undefined)];\n\n            case 2:\n              outEvent = _a.sent();\n              this.dispatchEvent(outEvent, 'pointerout');\n              if (isMouse) this.dispatchEvent(outEvent, 'mouseout');\n              if (!!e.composedPath().includes(outTarget)) return [3\n              /*break*/\n              , 4];\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, 'pointerleave', outTarget || undefined)];\n\n            case 3:\n              leaveEvent = _a.sent();\n              leaveEvent.eventPhase = leaveEvent.AT_TARGET;\n\n              while (leaveEvent.target && !e.composedPath().includes(leaveEvent.target)) {\n                leaveEvent.currentTarget = leaveEvent.target;\n                this.notifyTarget(leaveEvent);\n                if (isMouse) this.notifyTarget(leaveEvent, 'mouseleave');\n\n                if (Node.isNode(leaveEvent.target)) {\n                  leaveEvent.target = leaveEvent.target.parentNode;\n                }\n              }\n\n              this.freeEvent(leaveEvent);\n              _a.label = 4;\n\n            case 4:\n              this.freeEvent(outEvent);\n              _a.label = 5;\n\n            case 5:\n              // Then pointerover\n              if (outTarget !== e.target) {\n                overType = from.type === 'mousemove' ? 'mouseover' : 'pointerover';\n                overEvent = this.clonePointerEvent(e, overType);\n                this.dispatchEvent(overEvent, 'pointerover');\n                if (isMouse) this.dispatchEvent(overEvent, 'mouseover');\n                overTargetAncestor = outTarget && Node.isNode(outTarget) && outTarget.parentNode;\n\n                while (overTargetAncestor && overTargetAncestor !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                  if (overTargetAncestor === e.target) break;\n                  overTargetAncestor = overTargetAncestor.parentNode;\n                }\n\n                didPointerEnter = !overTargetAncestor || overTargetAncestor === (Node.isNode(this.rootTarget) && this.rootTarget.parentNode);\n\n                if (didPointerEnter) {\n                  enterEvent = this.clonePointerEvent(e, 'pointerenter');\n                  enterEvent.eventPhase = enterEvent.AT_TARGET;\n\n                  while (enterEvent.target && enterEvent.target !== outTarget && enterEvent.target !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                    enterEvent.currentTarget = enterEvent.target;\n                    this.notifyTarget(enterEvent);\n                    if (isMouse) this.notifyTarget(enterEvent, 'mouseenter');\n\n                    if (Node.isNode(enterEvent.target)) {\n                      enterEvent.target = enterEvent.target.parentNode;\n                    }\n                  }\n\n                  this.freeEvent(enterEvent);\n                }\n\n                this.freeEvent(overEvent);\n              } // Then pointermove\n\n\n              this.dispatchEvent(e, 'pointermove');\n              if (e.pointerType === 'touch') this.dispatchEvent(e, 'touchmove');\n\n              if (isMouse) {\n                this.dispatchEvent(e, 'mousemove');\n                this.cursor = this.getCursor(e.target);\n              }\n\n              trackingData.overTargets = e.composedPath();\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerOut = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var trackingData, isMouse, outTarget, outEvent, leaveEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              if (!trackingData.overTargets) return [3\n              /*break*/\n              , 3];\n              isMouse = from.pointerType === 'mouse' || from.pointerType === 'pen';\n              outTarget = this.findMountedTarget(trackingData.overTargets);\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, 'pointerout', outTarget || undefined)];\n\n            case 1:\n              outEvent = _a.sent();\n              this.dispatchEvent(outEvent);\n              if (isMouse) this.dispatchEvent(outEvent, 'mouseout');\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, 'pointerleave', outTarget || undefined)];\n\n            case 2:\n              leaveEvent = _a.sent();\n              leaveEvent.eventPhase = leaveEvent.AT_TARGET;\n\n              while (leaveEvent.target && leaveEvent.target !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                leaveEvent.currentTarget = leaveEvent.target;\n                this.notifyTarget(leaveEvent);\n                if (isMouse) this.notifyTarget(leaveEvent, 'mouseleave');\n\n                if (Node.isNode(leaveEvent.target)) {\n                  leaveEvent.target = leaveEvent.target.parentNode;\n                }\n              }\n\n              trackingData.overTargets = null;\n              this.freeEvent(outEvent);\n              this.freeEvent(leaveEvent);\n              _a.label = 3;\n\n            case 3:\n              this.cursor = null;\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerOver = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var trackingData, e, isMouse, enterEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              isMouse = e.pointerType === 'mouse' || e.pointerType === 'pen';\n              this.dispatchEvent(e, 'pointerover');\n              if (isMouse) this.dispatchEvent(e, 'mouseover');\n              if (e.pointerType === 'mouse') this.cursor = this.getCursor(e.target);\n              enterEvent = this.clonePointerEvent(e, 'pointerenter');\n              enterEvent.eventPhase = enterEvent.AT_TARGET;\n\n              while (enterEvent.target && enterEvent.target !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                enterEvent.currentTarget = enterEvent.target;\n                this.notifyTarget(enterEvent);\n\n                if (isMouse) {\n                  // mouseenter should not bubble\n                  // @see https://developer.mozilla.org/en-US/docs/Web/API/Element/mouseenter_event#usage_notes\n                  this.notifyTarget(enterEvent, 'mouseenter');\n                }\n\n                if (Node.isNode(enterEvent.target)) {\n                  enterEvent.target = enterEvent.target.parentNode;\n                }\n              }\n\n              trackingData.overTargets = e.composedPath();\n              this.freeEvent(e);\n              this.freeEvent(enterEvent);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerUpOutside = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var trackingData, pressTarget, e, currentTarget;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              pressTarget = this.findMountedTarget(trackingData.pressTargetsByButton[from.button]);\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n\n              if (pressTarget) {\n                currentTarget = pressTarget;\n\n                while (currentTarget) {\n                  e.currentTarget = currentTarget;\n                  this.notifyTarget(e, 'pointerupoutside');\n\n                  if (e.pointerType === 'touch') {\n                    this.notifyTarget(e, 'touchendoutside');\n                  } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                    this.notifyTarget(e, e.button === 2 ? 'rightupoutside' : 'mouseupoutside');\n                  }\n\n                  if (Node.isNode(currentTarget)) {\n                    currentTarget = currentTarget.parentNode;\n                  }\n                }\n\n                delete trackingData.pressTargetsByButton[from.button];\n              }\n\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onWheel = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var wheelEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedWheelEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              return [4\n              /*yield*/\n              , this.createWheelEvent(from)];\n\n            case 1:\n              wheelEvent = _a.sent();\n              this.dispatchEvent(wheelEvent);\n              this.freeEvent(wheelEvent);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    return _this;\n  }\n\n  EventService.prototype.init = function () {\n    this.rootTarget = this.renderingContext.root.parentNode; // document\n\n    this.addEventMapping('pointerdown', this.onPointerDown);\n    this.addEventMapping('pointerup', this.onPointerUp);\n    this.addEventMapping('pointermove', this.onPointerMove);\n    this.addEventMapping('pointerout', this.onPointerOut);\n    this.addEventMapping('pointerleave', this.onPointerOut);\n    this.addEventMapping('pointerover', this.onPointerOver);\n    this.addEventMapping('pointerupoutside', this.onPointerUpOutside);\n    this.addEventMapping('wheel', this.onWheel);\n  };\n\n  EventService.prototype.client2Viewport = function (client) {\n    var bbox = this.contextService.getBoundingClientRect();\n    return new Point(client.x - ((bbox === null || bbox === void 0 ? void 0 : bbox.left) || 0), client.y - ((bbox === null || bbox === void 0 ? void 0 : bbox.top) || 0));\n  };\n\n  EventService.prototype.viewport2Client = function (canvas) {\n    var bbox = this.contextService.getBoundingClientRect();\n    return new Point(canvas.x + ((bbox === null || bbox === void 0 ? void 0 : bbox.left) || 0), canvas.y + ((bbox === null || bbox === void 0 ? void 0 : bbox.top) || 0));\n  };\n\n  EventService.prototype.viewport2Canvas = function (_a) {\n    var x = _a.x,\n        y = _a.y;\n    var canvas = this.rootTarget.defaultView;\n    var camera = canvas.getCamera();\n    var _b = this.canvasConfig,\n        width = _b.width,\n        height = _b.height;\n    var projectionMatrixInverse = camera.getPerspectiveInverse();\n    var worldMatrix = camera.getWorldTransform();\n    var vpMatrix = mat4.multiply(mat4.create(), worldMatrix, projectionMatrixInverse);\n    var viewport = vec3.fromValues(x / width * 2 - 1, (1 - y / height) * 2 - 1, 0);\n    vec3.transformMat4(viewport, viewport, vpMatrix);\n    return new Point(viewport[0], viewport[1]);\n  };\n\n  EventService.prototype.canvas2Viewport = function (canvasP) {\n    var canvas = this.rootTarget.defaultView;\n    var camera = canvas.getCamera(); // World -> Clip\n\n    var projectionMatrix = camera.getPerspective();\n    var viewMatrix = camera.getViewTransform();\n    var vpMatrix = mat4.multiply(mat4.create(), projectionMatrix, viewMatrix);\n    var clip = vec3.fromValues(canvasP.x, canvasP.y, 0);\n    vec3.transformMat4(clip, clip, vpMatrix); // Clip -> NDC -> Viewport, flip Y\n\n    var _a = this.canvasConfig,\n        width = _a.width,\n        height = _a.height;\n    return new Point((clip[0] + 1) / 2 * width, (1 - (clip[1] + 1) / 2) * height);\n  };\n\n  EventService.prototype.setPickHandler = function (pickHandler) {\n    this.pickHandler = pickHandler;\n  };\n\n  EventService.prototype.addEventMapping = function (type, fn) {\n    if (!this.mappingTable[type]) {\n      this.mappingTable[type] = [];\n    }\n\n    this.mappingTable[type].push({\n      fn: fn,\n      priority: 0\n    });\n    this.mappingTable[type].sort(function (a, b) {\n      return a.priority - b.priority;\n    });\n  };\n\n  EventService.prototype.mapEvent = function (e) {\n    if (!this.rootTarget) {\n      return;\n    }\n\n    var mappers = this.mappingTable[e.type];\n\n    if (mappers) {\n      for (var i = 0, j = mappers.length; i < j; i++) {\n        mappers[i].fn(e);\n      }\n    } else {\n      console.warn(\"[EventService]: Event mapping not defined for \".concat(e.type));\n    }\n  };\n\n  EventService.prototype.dispatchEvent = function (e, type) {\n    e.propagationStopped = false;\n    e.propagationImmediatelyStopped = false;\n    this.propagate(e, type);\n    this.emit(type || e.type, e);\n  };\n\n  EventService.prototype.propagate = function (e, type) {\n    if (!e.target) {\n      return;\n    } // [target, parent, root, Canvas]\n\n\n    var composedPath = e.composedPath(); // event flow: capture -> target -> bubbling\n    // capture phase\n\n    e.eventPhase = e.CAPTURING_PHASE;\n\n    for (var i = composedPath.length - 1; i >= 1; i--) {\n      e.currentTarget = composedPath[i];\n      this.notifyTarget(e, type);\n      if (e.propagationStopped || e.propagationImmediatelyStopped) return;\n    } // target phase\n\n\n    e.eventPhase = e.AT_TARGET;\n    e.currentTarget = e.target;\n    this.notifyTarget(e, type);\n    if (e.propagationStopped || e.propagationImmediatelyStopped) return; // find current target in composed path\n\n    var index = composedPath.indexOf(e.currentTarget); // bubbling phase\n\n    e.eventPhase = e.BUBBLING_PHASE;\n\n    for (var i = index + 1; i < composedPath.length; i++) {\n      e.currentTarget = composedPath[i];\n      this.notifyTarget(e, type);\n      if (e.propagationStopped || e.propagationImmediatelyStopped) return;\n    }\n  };\n\n  EventService.prototype.propagationPath = function (target) {\n    var propagationPath = [target];\n    var canvas = this.rootTarget.defaultView || null;\n\n    if (canvas && canvas === target) {\n      propagationPath.unshift(canvas.document);\n      return propagationPath;\n    }\n\n    for (var i = 0; i < PROPAGATION_LIMIT && target !== this.rootTarget; i++) {\n      // if (Node.isNode(target) && !target.parentNode) {\n      //   throw new Error('Cannot find propagation path to disconnected target');\n      // }\n      if (Node.isNode(target) && target.parentNode) {\n        // [target, parent, parent, root]\n        propagationPath.push(target.parentNode);\n        target = target.parentNode;\n      }\n    }\n\n    if (canvas) {\n      // @ts-ignore\n      propagationPath.push(canvas);\n    }\n\n    return propagationPath;\n  };\n\n  EventService.prototype.hitTest = function (position) {\n    return __awaiter(this, void 0, void 0, function () {\n      var viewportX, viewportY, _a, width, height;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            viewportX = position.viewportX, viewportY = position.viewportY;\n            _a = this.canvasConfig, width = _a.width, height = _a.height; // outside canvas\n\n            if (viewportX < 0 || viewportY < 0 || viewportX > width || viewportY > height) {\n              return [2\n              /*return*/\n              , null];\n            }\n\n            return [4\n            /*yield*/\n            , this.pickHandler(position)];\n\n          case 1:\n            return [2\n            /*return*/\n            , _b.sent() || this.rootTarget || // return Document\n            null];\n        }\n      });\n    });\n  };\n\n  EventService.prototype.isNativeEventFromCanvas = function (event) {\n    var _a;\n\n    var $el = this.contextService.getDomElement();\n    var target = (_a = event.nativeEvent) === null || _a === void 0 ? void 0 : _a.target;\n\n    if (target) {\n      if (target === $el) {\n        return true;\n      }\n\n      if ($el && $el.contains) {\n        return $el.contains(target);\n      }\n    }\n\n    if (event.nativeEvent.composedPath) {\n      return event.nativeEvent.composedPath().indexOf($el) > -1;\n    } // account for Touch\n\n\n    return false;\n  };\n\n  EventService.prototype.createPointerEvent = function (from, type, target) {\n    return __awaiter(this, void 0, void 0, function () {\n      var event, isFromCanvas, _a, _b, _c;\n\n      return __generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            event = this.allocateEvent(FederatedPointerEvent);\n            this.copyPointerData(from, event);\n            this.copyMouseData(from, event);\n            this.copyData(from, event);\n            event.nativeEvent = from.nativeEvent;\n            isFromCanvas = this.isNativeEventFromCanvas(event);\n            event.originalEvent = from;\n            _a = event;\n            if (!(target !== null && target !== void 0)) return [3\n            /*break*/\n            , 1];\n            _b = target;\n            return [3\n            /*break*/\n            , 4];\n\n          case 1:\n            _c = isFromCanvas;\n            if (!_c) return [3\n            /*break*/\n            , 3];\n            return [4\n            /*yield*/\n            , this.hitTest({\n              clientX: event.clientX,\n              clientY: event.clientY,\n              viewportX: event.viewportX,\n              viewportY: event.viewportY,\n              x: event.global.x,\n              y: event.global.y\n            })];\n\n          case 2:\n            _c = _d.sent();\n            _d.label = 3;\n\n          case 3:\n            _b = _c;\n            _d.label = 4;\n\n          case 4:\n            _a.target = _b;\n\n            if (typeof type === 'string') {\n              event.type = type;\n            }\n\n            return [2\n            /*return*/\n            , event];\n        }\n      });\n    });\n  };\n\n  EventService.prototype.createWheelEvent = function (from) {\n    return __awaiter(this, void 0, void 0, function () {\n      var event, isFromCanvas, _a, _b;\n\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            event = this.allocateEvent(FederatedWheelEvent);\n            this.copyWheelData(from, event);\n            this.copyMouseData(from, event);\n            this.copyData(from, event);\n            event.nativeEvent = from.nativeEvent;\n            event.originalEvent = from;\n            isFromCanvas = this.isNativeEventFromCanvas(event);\n            _a = event;\n            _b = isFromCanvas;\n            if (!_b) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , this.hitTest({\n              clientX: event.clientX,\n              clientY: event.clientY,\n              viewportX: event.viewportX,\n              viewportY: event.viewportY,\n              x: event.global.x,\n              y: event.global.y\n            })];\n\n          case 1:\n            _b = _c.sent();\n            _c.label = 2;\n\n          case 2:\n            _a.target = _b;\n            return [2\n            /*return*/\n            , event];\n        }\n      });\n    });\n  };\n\n  EventService.prototype.trackingData = function (id) {\n    if (!this.mappingState.trackingData[id]) {\n      this.mappingState.trackingData[id] = {\n        pressTargetsByButton: {},\n        clicksByButton: {},\n        overTarget: null\n      };\n    }\n\n    return this.mappingState.trackingData[id];\n  };\n\n  EventService.prototype.clonePointerEvent = function (from, type) {\n    var event = this.allocateEvent(FederatedPointerEvent);\n    event.nativeEvent = from.nativeEvent;\n    event.originalEvent = from.originalEvent;\n    this.copyPointerData(from, event);\n    this.copyMouseData(from, event);\n    this.copyData(from, event);\n    event.target = from.target;\n    event.path = from.composedPath().slice();\n    event.type = type !== null && type !== void 0 ? type : event.type;\n    return event;\n  };\n\n  EventService.prototype.copyPointerData = function (from, to) {\n    if (!(from instanceof FederatedPointerEvent && to instanceof FederatedPointerEvent)) return;\n    to.pointerId = from.pointerId;\n    to.width = from.width;\n    to.height = from.height;\n    to.isPrimary = from.isPrimary;\n    to.pointerType = from.pointerType;\n    to.pressure = from.pressure;\n    to.tangentialPressure = from.tangentialPressure;\n    to.tiltX = from.tiltX;\n    to.tiltY = from.tiltY;\n    to.twist = from.twist;\n  };\n\n  EventService.prototype.copyMouseData = function (from, to) {\n    if (!(from instanceof FederatedMouseEvent && to instanceof FederatedMouseEvent)) return;\n    to.altKey = from.altKey;\n    to.button = from.button;\n    to.buttons = from.buttons;\n    to.ctrlKey = from.ctrlKey;\n    to.metaKey = from.metaKey;\n    to.client.copyFrom(from.client);\n    to.movement.copyFrom(from.movement);\n    to.canvas.copyFrom(from.canvas);\n    to.screen.copyFrom(from.screen);\n    to.global.copyFrom(from.global);\n    to.offset.copyFrom(from.offset);\n  };\n\n  EventService.prototype.copyWheelData = function (from, to) {\n    to.deltaMode = from.deltaMode;\n    to.deltaX = from.deltaX;\n    to.deltaY = from.deltaY;\n    to.deltaZ = from.deltaZ;\n  };\n\n  EventService.prototype.copyData = function (from, to) {\n    to.isTrusted = from.isTrusted;\n    to.timeStamp = performance.now();\n    to.type = from.type;\n    to.detail = from.detail;\n    to.view = from.view;\n    to.page.copyFrom(from.page);\n    to.viewport.copyFrom(from.viewport);\n  };\n\n  EventService.prototype.allocateEvent = function (constructor) {\n    if (!this.eventPool.has(constructor)) {\n      this.eventPool.set(constructor, []);\n    } // @ts-ignore\n\n\n    var event = this.eventPool.get(constructor).pop() || new constructor(this);\n    event.eventPhase = event.NONE;\n    event.currentTarget = null;\n    event.path = [];\n    event.target = null;\n    return event;\n  };\n\n  EventService.prototype.freeEvent = function (event) {\n    if (event.manager !== this) throw new Error('It is illegal to free an event not managed by this EventBoundary!');\n    var constructor = event.constructor;\n\n    if (!this.eventPool.has(constructor)) {\n      this.eventPool.set(constructor, []);\n    } // @ts-ignore\n\n\n    this.eventPool.get(constructor).push(event);\n  };\n\n  EventService.prototype.notifyTarget = function (e, type) {\n    type = type !== null && type !== void 0 ? type : e.type;\n    var key = e.eventPhase === e.CAPTURING_PHASE || e.eventPhase === e.AT_TARGET ? \"\".concat(type, \"capture\") : type;\n    this.notifyListeners(e, key);\n\n    if (e.eventPhase === e.AT_TARGET) {\n      this.notifyListeners(e, type);\n    }\n  };\n\n  EventService.prototype.notifyListeners = function (e, type) {\n    // hack EventEmitter, stops if the `propagationImmediatelyStopped` flag is set\n    var emitter = e.currentTarget.emitter; // @ts-ignore\n\n    var listeners = emitter._events[type];\n    if (!listeners) return;\n\n    if ('fn' in listeners) {\n      if (listeners.once) {\n        emitter.removeListener(type, listeners.fn, undefined, true);\n      }\n\n      listeners.fn.call(e.currentTarget || listeners.context, e); // listeners.fn.call(listeners.context, e);\n    } else {\n      for (var i = 0; i < listeners.length && !e.propagationImmediatelyStopped; i++) {\n        if (listeners[i].once) {\n          emitter.removeListener(type, listeners[i].fn, undefined, true);\n        }\n\n        listeners[i].fn.call(e.currentTarget || listeners[i].context, e); // listeners[i].fn.call(listeners[i].context, e);\n      }\n    }\n  };\n  /**\n   * some detached nodes may exist in propagation path, need to skip them\n   */\n\n\n  EventService.prototype.findMountedTarget = function (propagationPath) {\n    if (!propagationPath) {\n      return null;\n    }\n\n    var currentTarget = propagationPath[propagationPath.length - 1];\n\n    for (var i = propagationPath.length - 2; i >= 0; i--) {\n      var target = propagationPath[i];\n\n      if (target === this.rootTarget || Node.isNode(target) && target.parentNode === currentTarget) {\n        currentTarget = propagationPath[i];\n      } else {\n        break;\n      }\n    }\n\n    return currentTarget;\n  };\n\n  EventService.prototype.getCursor = function (target) {\n    var tmp = target;\n\n    while (tmp) {\n      var cursor = Element.isElement(tmp) && tmp.getAttribute('cursor');\n\n      if (cursor) {\n        return cursor;\n      }\n\n      tmp = Node.isNode(tmp) && tmp.parentNode;\n    }\n  };\n\n  __decorate([inject(RenderingContext), __metadata(\"design:type\", Object)], EventService.prototype, \"renderingContext\", void 0);\n\n  __decorate([inject(ContextService), __metadata(\"design:type\", Object)], EventService.prototype, \"contextService\", void 0);\n\n  __decorate([inject(CanvasConfig), __metadata(\"design:type\", Object)], EventService.prototype, \"canvasConfig\", void 0);\n\n  __decorate([postConstruct(), __metadata(\"design:type\", Function), __metadata(\"design:paramtypes\", []), __metadata(\"design:returntype\", void 0)], EventService.prototype, \"init\", null);\n\n  EventService = __decorate([singleton()], EventService);\n  return EventService;\n}(EventEmitter);\n\nexport { EventService };","map":{"version":3,"sources":["/Users/dennis.zhang/Desktop/其它代码库/moa-flow/node_modules/@antv/g/es/services/EventService.js"],"names":["__awaiter","__decorate","__extends","__generator","__metadata","mat4","vec3","inject","singleton","postConstruct","EventEmitter","CanvasConfig","Element","Node","FederatedMouseEvent","FederatedPointerEvent","FederatedWheelEvent","RenderingContext","Point","ContextService","PROPAGATION_LIMIT","EventService","_super","_this","apply","arguments","cursor","mappingTable","mappingState","trackingData","eventPool","Map","onPointerDown","from","e","isRightButton","_a","label","createPointerEvent","sent","dispatchEvent","pointerType","button","pointerId","pressTargetsByButton","composedPath","freeEvent","onPointerUp","now","pressTarget","clickTarget","currentTarget","clickEvent","clickHistory","performance","findMountedTarget","includes","notifyTarget","isNode","parentNode","clonePointerEvent","target","path","clicksByButton","clickCount","timeStamp","detail","onPointerMove","isMouse","outTarget","outType","outEvent","leaveEvent","overType","overEvent","overTargetAncestor","didPointerEnter","enterEvent","overTargets","type","undefined","eventPhase","AT_TARGET","rootTarget","getCursor","onPointerOut","onPointerOver","onPointerUpOutside","onWheel","wheelEvent","createWheelEvent","prototype","init","renderingContext","root","addEventMapping","client2Viewport","client","bbox","contextService","getBoundingClientRect","x","left","y","top","viewport2Client","canvas","viewport2Canvas","defaultView","camera","getCamera","_b","canvasConfig","width","height","projectionMatrixInverse","getPerspectiveInverse","worldMatrix","getWorldTransform","vpMatrix","multiply","create","viewport","fromValues","transformMat4","canvas2Viewport","canvasP","projectionMatrix","getPerspective","viewMatrix","getViewTransform","clip","setPickHandler","pickHandler","fn","push","priority","sort","a","b","mapEvent","mappers","i","j","length","console","warn","concat","propagationStopped","propagationImmediatelyStopped","propagate","emit","CAPTURING_PHASE","index","indexOf","BUBBLING_PHASE","propagationPath","unshift","document","hitTest","position","viewportX","viewportY","isNativeEventFromCanvas","event","$el","getDomElement","nativeEvent","contains","isFromCanvas","_c","_d","allocateEvent","copyPointerData","copyMouseData","copyData","originalEvent","clientX","clientY","global","copyWheelData","id","overTarget","slice","to","isPrimary","pressure","tangentialPressure","tiltX","tiltY","twist","altKey","buttons","ctrlKey","metaKey","copyFrom","movement","screen","offset","deltaMode","deltaX","deltaY","deltaZ","isTrusted","view","page","constructor","has","set","get","pop","NONE","manager","Error","key","notifyListeners","emitter","listeners","_events","once","removeListener","call","context","tmp","isElement","getAttribute","Object","Function"],"mappings":"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","sourcesContent":["import { __awaiter, __decorate, __extends, __generator, __metadata } from \"tslib\";\nimport { mat4, vec3 } from 'gl-matrix';\nimport { inject, singleton, postConstruct } from 'mana-syringe';\nimport { EventEmitter } from 'eventemitter3';\nimport { CanvasConfig } from '../types';\nimport { Element } from '../dom/Element';\nimport { Node } from '../dom/Node';\nimport { FederatedMouseEvent } from '../dom/FederatedMouseEvent';\nimport { FederatedPointerEvent } from '../dom/FederatedPointerEvent';\nimport { FederatedWheelEvent } from '../dom/FederatedWheelEvent';\nimport { RenderingContext } from './RenderingContext';\nimport { Point } from '../shapes';\nimport { ContextService } from './ContextService';\nvar PROPAGATION_LIMIT = 2048;\n\nvar EventService =\n/** @class */\nfunction (_super) {\n  __extends(EventService, _super);\n\n  function EventService() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.cursor = 'default';\n    _this.mappingTable = {};\n    _this.mappingState = {\n      trackingData: {}\n    };\n    _this.eventPool = new Map();\n\n    _this.onPointerDown = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var e, isRightButton, trackingData;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              this.dispatchEvent(e, 'pointerdown');\n\n              if (e.pointerType === 'touch') {\n                // only the\n                // if (e.isLast) {\n                this.dispatchEvent(e, 'touchstart'); // }\n              } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                isRightButton = e.button === 2;\n                this.dispatchEvent(e, isRightButton ? 'rightdown' : 'mousedown');\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              trackingData.pressTargetsByButton[from.button] = e.composedPath();\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerUp = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var now, e, isRightButton, trackingData, pressTarget, clickTarget, currentTarget, isRightButton, clickEvent, clickHistory;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              now = performance.now();\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              this.dispatchEvent(e, 'pointerup');\n\n              if (e.pointerType === 'touch') {\n                this.dispatchEvent(e, 'touchend');\n              } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                isRightButton = e.button === 2;\n                this.dispatchEvent(e, isRightButton ? 'rightup' : 'mouseup');\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              pressTarget = this.findMountedTarget(trackingData.pressTargetsByButton[from.button]);\n              clickTarget = pressTarget; // pointerupoutside only bubbles. It only bubbles upto the parent that doesn't contain\n              // the pointerup location.\n\n              if (pressTarget && !e.composedPath().includes(pressTarget)) {\n                currentTarget = pressTarget;\n\n                while (currentTarget && !e.composedPath().includes(currentTarget)) {\n                  e.currentTarget = currentTarget;\n                  this.notifyTarget(e, 'pointerupoutside');\n\n                  if (e.pointerType === 'touch') {\n                    this.notifyTarget(e, 'touchendoutside');\n                  } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                    isRightButton = e.button === 2;\n                    this.notifyTarget(e, isRightButton ? 'rightupoutside' : 'mouseupoutside');\n                  }\n\n                  if (Node.isNode(currentTarget)) {\n                    currentTarget = currentTarget.parentNode;\n                  }\n                }\n\n                delete trackingData.pressTargetsByButton[from.button]; // currentTarget is the most specific ancestor holding both the pointerdown and pointerup\n                // targets. That is - it's our click target!\n\n                clickTarget = currentTarget;\n              }\n\n              if (clickTarget) {\n                clickEvent = this.clonePointerEvent(e, 'click');\n                clickEvent.target = clickTarget;\n                clickEvent.path = [];\n\n                if (!trackingData.clicksByButton[from.button]) {\n                  trackingData.clicksByButton[from.button] = {\n                    clickCount: 0,\n                    target: clickEvent.target,\n                    timeStamp: now\n                  };\n                }\n\n                clickHistory = trackingData.clicksByButton[from.button];\n\n                if (clickHistory.target === clickEvent.target && now - clickHistory.timeStamp < 200) {\n                  ++clickHistory.clickCount;\n                } else {\n                  clickHistory.clickCount = 1;\n                }\n\n                clickHistory.target = clickEvent.target;\n                clickHistory.timeStamp = now;\n                clickEvent.detail = clickHistory.clickCount;\n\n                if (clickEvent.pointerType === 'mouse' || clickEvent.pointerType === 'touch') {\n                  this.dispatchEvent(clickEvent, 'click');\n                } else {\n                  this.dispatchEvent(clickEvent, 'pointertap');\n                }\n\n                this.freeEvent(clickEvent);\n              }\n\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerMove = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var e, isMouse, trackingData, outTarget, outType, outEvent, leaveEvent, overType, overEvent, overTargetAncestor, didPointerEnter, enterEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              isMouse = e.pointerType === 'mouse' || e.pointerType === 'pen';\n              trackingData = this.trackingData(from.pointerId);\n              outTarget = this.findMountedTarget(trackingData.overTargets);\n              if (!(trackingData.overTargets && outTarget !== e.target)) return [3\n              /*break*/\n              , 5];\n              outType = from.type === 'mousemove' ? 'mouseout' : 'pointerout';\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, outType, outTarget || undefined)];\n\n            case 2:\n              outEvent = _a.sent();\n              this.dispatchEvent(outEvent, 'pointerout');\n              if (isMouse) this.dispatchEvent(outEvent, 'mouseout');\n              if (!!e.composedPath().includes(outTarget)) return [3\n              /*break*/\n              , 4];\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, 'pointerleave', outTarget || undefined)];\n\n            case 3:\n              leaveEvent = _a.sent();\n              leaveEvent.eventPhase = leaveEvent.AT_TARGET;\n\n              while (leaveEvent.target && !e.composedPath().includes(leaveEvent.target)) {\n                leaveEvent.currentTarget = leaveEvent.target;\n                this.notifyTarget(leaveEvent);\n                if (isMouse) this.notifyTarget(leaveEvent, 'mouseleave');\n\n                if (Node.isNode(leaveEvent.target)) {\n                  leaveEvent.target = leaveEvent.target.parentNode;\n                }\n              }\n\n              this.freeEvent(leaveEvent);\n              _a.label = 4;\n\n            case 4:\n              this.freeEvent(outEvent);\n              _a.label = 5;\n\n            case 5:\n              // Then pointerover\n              if (outTarget !== e.target) {\n                overType = from.type === 'mousemove' ? 'mouseover' : 'pointerover';\n                overEvent = this.clonePointerEvent(e, overType);\n                this.dispatchEvent(overEvent, 'pointerover');\n                if (isMouse) this.dispatchEvent(overEvent, 'mouseover');\n                overTargetAncestor = outTarget && Node.isNode(outTarget) && outTarget.parentNode;\n\n                while (overTargetAncestor && overTargetAncestor !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                  if (overTargetAncestor === e.target) break;\n                  overTargetAncestor = overTargetAncestor.parentNode;\n                }\n\n                didPointerEnter = !overTargetAncestor || overTargetAncestor === (Node.isNode(this.rootTarget) && this.rootTarget.parentNode);\n\n                if (didPointerEnter) {\n                  enterEvent = this.clonePointerEvent(e, 'pointerenter');\n                  enterEvent.eventPhase = enterEvent.AT_TARGET;\n\n                  while (enterEvent.target && enterEvent.target !== outTarget && enterEvent.target !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                    enterEvent.currentTarget = enterEvent.target;\n                    this.notifyTarget(enterEvent);\n                    if (isMouse) this.notifyTarget(enterEvent, 'mouseenter');\n\n                    if (Node.isNode(enterEvent.target)) {\n                      enterEvent.target = enterEvent.target.parentNode;\n                    }\n                  }\n\n                  this.freeEvent(enterEvent);\n                }\n\n                this.freeEvent(overEvent);\n              } // Then pointermove\n\n\n              this.dispatchEvent(e, 'pointermove');\n              if (e.pointerType === 'touch') this.dispatchEvent(e, 'touchmove');\n\n              if (isMouse) {\n                this.dispatchEvent(e, 'mousemove');\n                this.cursor = this.getCursor(e.target);\n              }\n\n              trackingData.overTargets = e.composedPath();\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerOut = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var trackingData, isMouse, outTarget, outEvent, leaveEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              if (!trackingData.overTargets) return [3\n              /*break*/\n              , 3];\n              isMouse = from.pointerType === 'mouse' || from.pointerType === 'pen';\n              outTarget = this.findMountedTarget(trackingData.overTargets);\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, 'pointerout', outTarget || undefined)];\n\n            case 1:\n              outEvent = _a.sent();\n              this.dispatchEvent(outEvent);\n              if (isMouse) this.dispatchEvent(outEvent, 'mouseout');\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from, 'pointerleave', outTarget || undefined)];\n\n            case 2:\n              leaveEvent = _a.sent();\n              leaveEvent.eventPhase = leaveEvent.AT_TARGET;\n\n              while (leaveEvent.target && leaveEvent.target !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                leaveEvent.currentTarget = leaveEvent.target;\n                this.notifyTarget(leaveEvent);\n                if (isMouse) this.notifyTarget(leaveEvent, 'mouseleave');\n\n                if (Node.isNode(leaveEvent.target)) {\n                  leaveEvent.target = leaveEvent.target.parentNode;\n                }\n              }\n\n              trackingData.overTargets = null;\n              this.freeEvent(outEvent);\n              this.freeEvent(leaveEvent);\n              _a.label = 3;\n\n            case 3:\n              this.cursor = null;\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerOver = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var trackingData, e, isMouse, enterEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n              isMouse = e.pointerType === 'mouse' || e.pointerType === 'pen';\n              this.dispatchEvent(e, 'pointerover');\n              if (isMouse) this.dispatchEvent(e, 'mouseover');\n              if (e.pointerType === 'mouse') this.cursor = this.getCursor(e.target);\n              enterEvent = this.clonePointerEvent(e, 'pointerenter');\n              enterEvent.eventPhase = enterEvent.AT_TARGET;\n\n              while (enterEvent.target && enterEvent.target !== (Node.isNode(this.rootTarget) && this.rootTarget.parentNode)) {\n                enterEvent.currentTarget = enterEvent.target;\n                this.notifyTarget(enterEvent);\n\n                if (isMouse) {\n                  // mouseenter should not bubble\n                  // @see https://developer.mozilla.org/en-US/docs/Web/API/Element/mouseenter_event#usage_notes\n                  this.notifyTarget(enterEvent, 'mouseenter');\n                }\n\n                if (Node.isNode(enterEvent.target)) {\n                  enterEvent.target = enterEvent.target.parentNode;\n                }\n              }\n\n              trackingData.overTargets = e.composedPath();\n              this.freeEvent(e);\n              this.freeEvent(enterEvent);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onPointerUpOutside = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var trackingData, pressTarget, e, currentTarget;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedPointerEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              trackingData = this.trackingData(from.pointerId);\n              pressTarget = this.findMountedTarget(trackingData.pressTargetsByButton[from.button]);\n              return [4\n              /*yield*/\n              , this.createPointerEvent(from)];\n\n            case 1:\n              e = _a.sent();\n\n              if (pressTarget) {\n                currentTarget = pressTarget;\n\n                while (currentTarget) {\n                  e.currentTarget = currentTarget;\n                  this.notifyTarget(e, 'pointerupoutside');\n\n                  if (e.pointerType === 'touch') {\n                    this.notifyTarget(e, 'touchendoutside');\n                  } else if (e.pointerType === 'mouse' || e.pointerType === 'pen') {\n                    this.notifyTarget(e, e.button === 2 ? 'rightupoutside' : 'mouseupoutside');\n                  }\n\n                  if (Node.isNode(currentTarget)) {\n                    currentTarget = currentTarget.parentNode;\n                  }\n                }\n\n                delete trackingData.pressTargetsByButton[from.button];\n              }\n\n              this.freeEvent(e);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.onWheel = function (from) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var wheelEvent;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(from instanceof FederatedWheelEvent)) {\n                return [2\n                /*return*/\n                ];\n              }\n\n              return [4\n              /*yield*/\n              , this.createWheelEvent(from)];\n\n            case 1:\n              wheelEvent = _a.sent();\n              this.dispatchEvent(wheelEvent);\n              this.freeEvent(wheelEvent);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    return _this;\n  }\n\n  EventService.prototype.init = function () {\n    this.rootTarget = this.renderingContext.root.parentNode; // document\n\n    this.addEventMapping('pointerdown', this.onPointerDown);\n    this.addEventMapping('pointerup', this.onPointerUp);\n    this.addEventMapping('pointermove', this.onPointerMove);\n    this.addEventMapping('pointerout', this.onPointerOut);\n    this.addEventMapping('pointerleave', this.onPointerOut);\n    this.addEventMapping('pointerover', this.onPointerOver);\n    this.addEventMapping('pointerupoutside', this.onPointerUpOutside);\n    this.addEventMapping('wheel', this.onWheel);\n  };\n\n  EventService.prototype.client2Viewport = function (client) {\n    var bbox = this.contextService.getBoundingClientRect();\n    return new Point(client.x - ((bbox === null || bbox === void 0 ? void 0 : bbox.left) || 0), client.y - ((bbox === null || bbox === void 0 ? void 0 : bbox.top) || 0));\n  };\n\n  EventService.prototype.viewport2Client = function (canvas) {\n    var bbox = this.contextService.getBoundingClientRect();\n    return new Point(canvas.x + ((bbox === null || bbox === void 0 ? void 0 : bbox.left) || 0), canvas.y + ((bbox === null || bbox === void 0 ? void 0 : bbox.top) || 0));\n  };\n\n  EventService.prototype.viewport2Canvas = function (_a) {\n    var x = _a.x,\n        y = _a.y;\n    var canvas = this.rootTarget.defaultView;\n    var camera = canvas.getCamera();\n    var _b = this.canvasConfig,\n        width = _b.width,\n        height = _b.height;\n    var projectionMatrixInverse = camera.getPerspectiveInverse();\n    var worldMatrix = camera.getWorldTransform();\n    var vpMatrix = mat4.multiply(mat4.create(), worldMatrix, projectionMatrixInverse);\n    var viewport = vec3.fromValues(x / width * 2 - 1, (1 - y / height) * 2 - 1, 0);\n    vec3.transformMat4(viewport, viewport, vpMatrix);\n    return new Point(viewport[0], viewport[1]);\n  };\n\n  EventService.prototype.canvas2Viewport = function (canvasP) {\n    var canvas = this.rootTarget.defaultView;\n    var camera = canvas.getCamera(); // World -> Clip\n\n    var projectionMatrix = camera.getPerspective();\n    var viewMatrix = camera.getViewTransform();\n    var vpMatrix = mat4.multiply(mat4.create(), projectionMatrix, viewMatrix);\n    var clip = vec3.fromValues(canvasP.x, canvasP.y, 0);\n    vec3.transformMat4(clip, clip, vpMatrix); // Clip -> NDC -> Viewport, flip Y\n\n    var _a = this.canvasConfig,\n        width = _a.width,\n        height = _a.height;\n    return new Point((clip[0] + 1) / 2 * width, (1 - (clip[1] + 1) / 2) * height);\n  };\n\n  EventService.prototype.setPickHandler = function (pickHandler) {\n    this.pickHandler = pickHandler;\n  };\n\n  EventService.prototype.addEventMapping = function (type, fn) {\n    if (!this.mappingTable[type]) {\n      this.mappingTable[type] = [];\n    }\n\n    this.mappingTable[type].push({\n      fn: fn,\n      priority: 0\n    });\n    this.mappingTable[type].sort(function (a, b) {\n      return a.priority - b.priority;\n    });\n  };\n\n  EventService.prototype.mapEvent = function (e) {\n    if (!this.rootTarget) {\n      return;\n    }\n\n    var mappers = this.mappingTable[e.type];\n\n    if (mappers) {\n      for (var i = 0, j = mappers.length; i < j; i++) {\n        mappers[i].fn(e);\n      }\n    } else {\n      console.warn(\"[EventService]: Event mapping not defined for \".concat(e.type));\n    }\n  };\n\n  EventService.prototype.dispatchEvent = function (e, type) {\n    e.propagationStopped = false;\n    e.propagationImmediatelyStopped = false;\n    this.propagate(e, type);\n    this.emit(type || e.type, e);\n  };\n\n  EventService.prototype.propagate = function (e, type) {\n    if (!e.target) {\n      return;\n    } // [target, parent, root, Canvas]\n\n\n    var composedPath = e.composedPath(); // event flow: capture -> target -> bubbling\n    // capture phase\n\n    e.eventPhase = e.CAPTURING_PHASE;\n\n    for (var i = composedPath.length - 1; i >= 1; i--) {\n      e.currentTarget = composedPath[i];\n      this.notifyTarget(e, type);\n      if (e.propagationStopped || e.propagationImmediatelyStopped) return;\n    } // target phase\n\n\n    e.eventPhase = e.AT_TARGET;\n    e.currentTarget = e.target;\n    this.notifyTarget(e, type);\n    if (e.propagationStopped || e.propagationImmediatelyStopped) return; // find current target in composed path\n\n    var index = composedPath.indexOf(e.currentTarget); // bubbling phase\n\n    e.eventPhase = e.BUBBLING_PHASE;\n\n    for (var i = index + 1; i < composedPath.length; i++) {\n      e.currentTarget = composedPath[i];\n      this.notifyTarget(e, type);\n      if (e.propagationStopped || e.propagationImmediatelyStopped) return;\n    }\n  };\n\n  EventService.prototype.propagationPath = function (target) {\n    var propagationPath = [target];\n    var canvas = this.rootTarget.defaultView || null;\n\n    if (canvas && canvas === target) {\n      propagationPath.unshift(canvas.document);\n      return propagationPath;\n    }\n\n    for (var i = 0; i < PROPAGATION_LIMIT && target !== this.rootTarget; i++) {\n      // if (Node.isNode(target) && !target.parentNode) {\n      //   throw new Error('Cannot find propagation path to disconnected target');\n      // }\n      if (Node.isNode(target) && target.parentNode) {\n        // [target, parent, parent, root]\n        propagationPath.push(target.parentNode);\n        target = target.parentNode;\n      }\n    }\n\n    if (canvas) {\n      // @ts-ignore\n      propagationPath.push(canvas);\n    }\n\n    return propagationPath;\n  };\n\n  EventService.prototype.hitTest = function (position) {\n    return __awaiter(this, void 0, void 0, function () {\n      var viewportX, viewportY, _a, width, height;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            viewportX = position.viewportX, viewportY = position.viewportY;\n            _a = this.canvasConfig, width = _a.width, height = _a.height; // outside canvas\n\n            if (viewportX < 0 || viewportY < 0 || viewportX > width || viewportY > height) {\n              return [2\n              /*return*/\n              , null];\n            }\n\n            return [4\n            /*yield*/\n            , this.pickHandler(position)];\n\n          case 1:\n            return [2\n            /*return*/\n            , _b.sent() || this.rootTarget || // return Document\n            null];\n        }\n      });\n    });\n  };\n\n  EventService.prototype.isNativeEventFromCanvas = function (event) {\n    var _a;\n\n    var $el = this.contextService.getDomElement();\n    var target = (_a = event.nativeEvent) === null || _a === void 0 ? void 0 : _a.target;\n\n    if (target) {\n      if (target === $el) {\n        return true;\n      }\n\n      if ($el && $el.contains) {\n        return $el.contains(target);\n      }\n    }\n\n    if (event.nativeEvent.composedPath) {\n      return event.nativeEvent.composedPath().indexOf($el) > -1;\n    } // account for Touch\n\n\n    return false;\n  };\n\n  EventService.prototype.createPointerEvent = function (from, type, target) {\n    return __awaiter(this, void 0, void 0, function () {\n      var event, isFromCanvas, _a, _b, _c;\n\n      return __generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            event = this.allocateEvent(FederatedPointerEvent);\n            this.copyPointerData(from, event);\n            this.copyMouseData(from, event);\n            this.copyData(from, event);\n            event.nativeEvent = from.nativeEvent;\n            isFromCanvas = this.isNativeEventFromCanvas(event);\n            event.originalEvent = from;\n            _a = event;\n            if (!(target !== null && target !== void 0)) return [3\n            /*break*/\n            , 1];\n            _b = target;\n            return [3\n            /*break*/\n            , 4];\n\n          case 1:\n            _c = isFromCanvas;\n            if (!_c) return [3\n            /*break*/\n            , 3];\n            return [4\n            /*yield*/\n            , this.hitTest({\n              clientX: event.clientX,\n              clientY: event.clientY,\n              viewportX: event.viewportX,\n              viewportY: event.viewportY,\n              x: event.global.x,\n              y: event.global.y\n            })];\n\n          case 2:\n            _c = _d.sent();\n            _d.label = 3;\n\n          case 3:\n            _b = _c;\n            _d.label = 4;\n\n          case 4:\n            _a.target = _b;\n\n            if (typeof type === 'string') {\n              event.type = type;\n            }\n\n            return [2\n            /*return*/\n            , event];\n        }\n      });\n    });\n  };\n\n  EventService.prototype.createWheelEvent = function (from) {\n    return __awaiter(this, void 0, void 0, function () {\n      var event, isFromCanvas, _a, _b;\n\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            event = this.allocateEvent(FederatedWheelEvent);\n            this.copyWheelData(from, event);\n            this.copyMouseData(from, event);\n            this.copyData(from, event);\n            event.nativeEvent = from.nativeEvent;\n            event.originalEvent = from;\n            isFromCanvas = this.isNativeEventFromCanvas(event);\n            _a = event;\n            _b = isFromCanvas;\n            if (!_b) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , this.hitTest({\n              clientX: event.clientX,\n              clientY: event.clientY,\n              viewportX: event.viewportX,\n              viewportY: event.viewportY,\n              x: event.global.x,\n              y: event.global.y\n            })];\n\n          case 1:\n            _b = _c.sent();\n            _c.label = 2;\n\n          case 2:\n            _a.target = _b;\n            return [2\n            /*return*/\n            , event];\n        }\n      });\n    });\n  };\n\n  EventService.prototype.trackingData = function (id) {\n    if (!this.mappingState.trackingData[id]) {\n      this.mappingState.trackingData[id] = {\n        pressTargetsByButton: {},\n        clicksByButton: {},\n        overTarget: null\n      };\n    }\n\n    return this.mappingState.trackingData[id];\n  };\n\n  EventService.prototype.clonePointerEvent = function (from, type) {\n    var event = this.allocateEvent(FederatedPointerEvent);\n    event.nativeEvent = from.nativeEvent;\n    event.originalEvent = from.originalEvent;\n    this.copyPointerData(from, event);\n    this.copyMouseData(from, event);\n    this.copyData(from, event);\n    event.target = from.target;\n    event.path = from.composedPath().slice();\n    event.type = type !== null && type !== void 0 ? type : event.type;\n    return event;\n  };\n\n  EventService.prototype.copyPointerData = function (from, to) {\n    if (!(from instanceof FederatedPointerEvent && to instanceof FederatedPointerEvent)) return;\n    to.pointerId = from.pointerId;\n    to.width = from.width;\n    to.height = from.height;\n    to.isPrimary = from.isPrimary;\n    to.pointerType = from.pointerType;\n    to.pressure = from.pressure;\n    to.tangentialPressure = from.tangentialPressure;\n    to.tiltX = from.tiltX;\n    to.tiltY = from.tiltY;\n    to.twist = from.twist;\n  };\n\n  EventService.prototype.copyMouseData = function (from, to) {\n    if (!(from instanceof FederatedMouseEvent && to instanceof FederatedMouseEvent)) return;\n    to.altKey = from.altKey;\n    to.button = from.button;\n    to.buttons = from.buttons;\n    to.ctrlKey = from.ctrlKey;\n    to.metaKey = from.metaKey;\n    to.client.copyFrom(from.client);\n    to.movement.copyFrom(from.movement);\n    to.canvas.copyFrom(from.canvas);\n    to.screen.copyFrom(from.screen);\n    to.global.copyFrom(from.global);\n    to.offset.copyFrom(from.offset);\n  };\n\n  EventService.prototype.copyWheelData = function (from, to) {\n    to.deltaMode = from.deltaMode;\n    to.deltaX = from.deltaX;\n    to.deltaY = from.deltaY;\n    to.deltaZ = from.deltaZ;\n  };\n\n  EventService.prototype.copyData = function (from, to) {\n    to.isTrusted = from.isTrusted;\n    to.timeStamp = performance.now();\n    to.type = from.type;\n    to.detail = from.detail;\n    to.view = from.view;\n    to.page.copyFrom(from.page);\n    to.viewport.copyFrom(from.viewport);\n  };\n\n  EventService.prototype.allocateEvent = function (constructor) {\n    if (!this.eventPool.has(constructor)) {\n      this.eventPool.set(constructor, []);\n    } // @ts-ignore\n\n\n    var event = this.eventPool.get(constructor).pop() || new constructor(this);\n    event.eventPhase = event.NONE;\n    event.currentTarget = null;\n    event.path = [];\n    event.target = null;\n    return event;\n  };\n\n  EventService.prototype.freeEvent = function (event) {\n    if (event.manager !== this) throw new Error('It is illegal to free an event not managed by this EventBoundary!');\n    var constructor = event.constructor;\n\n    if (!this.eventPool.has(constructor)) {\n      this.eventPool.set(constructor, []);\n    } // @ts-ignore\n\n\n    this.eventPool.get(constructor).push(event);\n  };\n\n  EventService.prototype.notifyTarget = function (e, type) {\n    type = type !== null && type !== void 0 ? type : e.type;\n    var key = e.eventPhase === e.CAPTURING_PHASE || e.eventPhase === e.AT_TARGET ? \"\".concat(type, \"capture\") : type;\n    this.notifyListeners(e, key);\n\n    if (e.eventPhase === e.AT_TARGET) {\n      this.notifyListeners(e, type);\n    }\n  };\n\n  EventService.prototype.notifyListeners = function (e, type) {\n    // hack EventEmitter, stops if the `propagationImmediatelyStopped` flag is set\n    var emitter = e.currentTarget.emitter; // @ts-ignore\n\n    var listeners = emitter._events[type];\n    if (!listeners) return;\n\n    if ('fn' in listeners) {\n      if (listeners.once) {\n        emitter.removeListener(type, listeners.fn, undefined, true);\n      }\n\n      listeners.fn.call(e.currentTarget || listeners.context, e); // listeners.fn.call(listeners.context, e);\n    } else {\n      for (var i = 0; i < listeners.length && !e.propagationImmediatelyStopped; i++) {\n        if (listeners[i].once) {\n          emitter.removeListener(type, listeners[i].fn, undefined, true);\n        }\n\n        listeners[i].fn.call(e.currentTarget || listeners[i].context, e); // listeners[i].fn.call(listeners[i].context, e);\n      }\n    }\n  };\n  /**\n   * some detached nodes may exist in propagation path, need to skip them\n   */\n\n\n  EventService.prototype.findMountedTarget = function (propagationPath) {\n    if (!propagationPath) {\n      return null;\n    }\n\n    var currentTarget = propagationPath[propagationPath.length - 1];\n\n    for (var i = propagationPath.length - 2; i >= 0; i--) {\n      var target = propagationPath[i];\n\n      if (target === this.rootTarget || Node.isNode(target) && target.parentNode === currentTarget) {\n        currentTarget = propagationPath[i];\n      } else {\n        break;\n      }\n    }\n\n    return currentTarget;\n  };\n\n  EventService.prototype.getCursor = function (target) {\n    var tmp = target;\n\n    while (tmp) {\n      var cursor = Element.isElement(tmp) && tmp.getAttribute('cursor');\n\n      if (cursor) {\n        return cursor;\n      }\n\n      tmp = Node.isNode(tmp) && tmp.parentNode;\n    }\n  };\n\n  __decorate([inject(RenderingContext), __metadata(\"design:type\", Object)], EventService.prototype, \"renderingContext\", void 0);\n\n  __decorate([inject(ContextService), __metadata(\"design:type\", Object)], EventService.prototype, \"contextService\", void 0);\n\n  __decorate([inject(CanvasConfig), __metadata(\"design:type\", Object)], EventService.prototype, \"canvasConfig\", void 0);\n\n  __decorate([postConstruct(), __metadata(\"design:type\", Function), __metadata(\"design:paramtypes\", []), __metadata(\"design:returntype\", void 0)], EventService.prototype, \"init\", null);\n\n  EventService = __decorate([singleton()], EventService);\n  return EventService;\n}(EventEmitter);\n\nexport { EventService };"]},"metadata":{},"sourceType":"module"}