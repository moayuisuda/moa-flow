{"ast":null,"code":"import { __extends, __assign, __decorate } from './node_modules/tslib/tslib.es6.js';\nimport { Group, Circle, Canvas } from '@antv/react-g';\nimport LinkingEdge from './cells/LinkingEdge.js';\nimport React, { useContext, useState, useEffect, createRef } from 'react';\nimport { FlowModel } from './Model.js';\nimport { Renderer } from '@antv/g-canvas';\nimport { observer } from 'mobx-react';\nimport { computed, autorun } from 'mobx';\nimport { FlowContext } from './Context.js';\nimport { registComponents } from './utils/registComponents.js';\nimport SelectBoundsRect from './scaffold/SelectBoundsRect.js';\nimport { initClearState, initLink, initDrag, initSelect, initScale, initMultiSelect, initHotKeys } from './events.js';\nimport { STAGE_CLASS_NAME } from './constants.js';\nimport { getRightClickPanel } from './components/RightClickPanel/index.js';\nimport { color } from './theme/style.js';\nvar renderer = new Renderer();\n\nvar renderComponent = function (cellData, model) {\n  return React.createElement(model.componentsMap.get(cellData.component) || Group, {\n    data: cellData,\n    key: cellData.id\n  });\n};\n\nvar Dots = observer(function () {\n  var model = useContext(FlowContext); // const EXTRA = model.grid as number;\n\n  var EXTRA = 0;\n\n  var _dots = computed(function () {\n    var re = []; // @TODO\n\n    for (var i = -EXTRA; i <= model.height() + EXTRA; i += model.grid) {\n      for (var j = -EXTRA; j <= model.width() + EXTRA; j += model.grid) {\n        re.push({\n          x: j,\n          y: i\n        });\n      }\n    }\n\n    return re;\n  }).get();\n\n  return React.createElement(Group, null, _dots.map(function (dot) {\n    return React.createElement(Circle, {\n      x: dot.x,\n      y: dot.y,\n      r: 1,\n      fill: color.deepGrey\n    });\n  }));\n});\n\nvar Grid =\n/** @class */\nfunction (_super) {\n  __extends(Grid, _super);\n\n  function Grid(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.gridRef = React.createRef();\n    return _this;\n  }\n\n  Grid.prototype.componentDidMount = function () {\n    autorun(function () {// console.log(this.context.width(), this.context.height());\n      // requestAnimationFrame(() => {\n      //   if (this.gridRef.current) {\n      //     this.gridRef.current.isCached() && this.gridRef.current.clearCache();\n      //     this.gridRef.current.cache();\n      //   }\n      // });\n    });\n  };\n\n  Grid.prototype.render = function () {\n    var _this = this;\n\n    var grid = this.context.grid;\n\n    var _gridPos = computed(function () {\n      return {\n        x: -Math.round(_this.context.x() / _this.context.scale() / grid) * grid,\n        y: -Math.round(_this.context.y() / _this.context.scale() / grid) * grid\n      };\n    }).get();\n\n    return React.createElement(Group, __assign({}, _gridPos, {\n      zIndex: 0,\n      ref: this.gridRef,\n      visibility: this.context.grid && this.context.scale() >= 1 ? \"visible\" : \"hidden\"\n    }), React.createElement(Dots, null));\n  };\n\n  Grid.contextType = FlowContext;\n  Grid = __decorate([observer], Grid);\n  return Grid;\n}(React.Component);\n\nvar Edges = observer(function (props) {\n  var linesLayerRef = props.linesLayerRef,\n      model = props.model;\n\n  var _a = useState(0);\n\n  _a[0];\n  var setSecondRefresh = _a[1];\n  useEffect(function () {\n    setSecondRefresh(1);\n  }, []);\n  var edgesData = model.canvasData.cells.filter(function (cellData) {\n    return cellData.cellType === \"edge\";\n  });\n  return React.createElement(Group, {\n    ref: linesLayerRef,\n    zIndex: 1\n  }, edgesData.map(function (cellData) {\n    return renderComponent(cellData, model);\n  }));\n});\nvar Nodes = observer(function (props) {\n  var nodesLayerRef = props.nodesLayerRef,\n      model = props.model;\n  var nodesData = model.canvasData.cells.filter(function (cellData) {\n    return cellData.cellType !== \"edge\";\n  });\n  return React.createElement(Group, {\n    ref: nodesLayerRef,\n    zIndex: 2\n  }, nodesData.slice(0, nodesData.length).map(function (cellData) {\n    return renderComponent(cellData, model);\n  }));\n});\nvar InteractTop = observer(function (props) {\n  var model = props.model,\n      topLayerRef = props.topLayerRef;\n  return React.createElement(Group, {\n    zIndex: 3,\n    ref: topLayerRef\n  }, React.createElement(LinkingEdge, {\n    data: model.buffer.link\n  }), React.createElement(SelectBoundsRect, null));\n});\n\nvar Flow =\n/** @class */\nfunction (_super) {\n  __extends(Flow, _super);\n\n  function Flow(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.flowModel = new FlowModel(props.onEvent);\n    _this.props.canvasData && _this.flowModel.setCanvasData(_this.props.canvasData);\n    _this.props.grid && _this.flowModel.setGrid(_this.props.grid);\n\n    if (_this.props.width && _this.props.height) {\n      _this.flowModel.setSize(_this.props.width, _this.props.height);\n    }\n\n    props.modelRef && (props.modelRef.current = _this.flowModel);\n    props.onLoad && props.onLoad(_this.flowModel);\n    var refs = _this.flowModel.refs;\n    _this.stageRef = refs.stageRef = createRef();\n    _this.nodesLayerRef = refs.nodesLayerRef = createRef();\n    _this.linesLayerRef = refs.linesLayerRef = createRef();\n    _this.topLayerRef = createRef();\n    registComponents(_this.flowModel);\n    return _this;\n  }\n\n  Flow.prototype.componentDidMount = function () {\n    var model = this.flowModel;\n    var stage = this.stageRef.current;\n    var _a = this.props,\n        _b = _a.zoom,\n        zoom = _b === void 0 ? true : _b,\n        _c = _a.multiSelect,\n        multiSelect = _c === void 0 ? false : _c;\n    initClearState(model, stage);\n    initLink(model, stage);\n    initDrag(model, stage);\n    initSelect(model);\n    zoom && initScale(model, stage);\n    multiSelect && initMultiSelect(model, stage);\n    initHotKeys(model, stage);\n    initHotKeys(model, stage);\n  };\n\n  Flow.prototype.render = function () {\n    var model = this.flowModel;\n    return React.createElement(\"div\", {\n      style: {\n        position: \"relative\"\n      },\n      id: STAGE_CLASS_NAME\n    }, React.createElement(FlowContext.Provider, {\n      value: model\n    }, getRightClickPanel(this.props.children), React.createElement(Canvas, {\n      renderer: renderer,\n      className: STAGE_CLASS_NAME,\n      ref: this.stageRef,\n      width: model.width(),\n      height: model.height()\n    }, React.createElement(Group, {\n      transform: \"scale(\".concat(model.scale(), \", \").concat(model.scale(), \")\"),\n      x: model.x(),\n      y: model.y()\n    }, React.createElement(FlowContext.Provider, {\n      value: model\n    }, this.props.grid && React.createElement(Grid, null), React.createElement(Nodes, {\n      nodesLayerRef: this.nodesLayerRef,\n      model: model\n    }), React.createElement(Edges, {\n      linesLayerRef: this.linesLayerRef,\n      model: model\n    }), React.createElement(InteractTop, {\n      topLayerRef: this.topLayerRef,\n      model: model\n    }))))));\n  };\n\n  Flow = __decorate([observer], Flow);\n  return Flow;\n}(React.Component);\n\nexport { Flow as default };","map":{"version":3,"sources":["/Users/dennis.zhang/Desktop/其它代码库/moa-flow/packages/flow/lib/Flow.js"],"names":["__extends","__assign","__decorate","Group","Circle","Canvas","LinkingEdge","React","useContext","useState","useEffect","createRef","FlowModel","Renderer","observer","computed","autorun","FlowContext","registComponents","SelectBoundsRect","initClearState","initLink","initDrag","initSelect","initScale","initMultiSelect","initHotKeys","STAGE_CLASS_NAME","getRightClickPanel","color","renderer","renderComponent","cellData","model","createElement","componentsMap","get","component","data","key","id","Dots","EXTRA","_dots","re","i","height","grid","j","width","push","x","y","map","dot","r","fill","deepGrey","Grid","_super","props","_this","call","gridRef","prototype","componentDidMount","render","context","_gridPos","Math","round","scale","zIndex","ref","visibility","contextType","Component","Edges","linesLayerRef","_a","setSecondRefresh","edgesData","canvasData","cells","filter","cellType","Nodes","nodesLayerRef","nodesData","slice","length","InteractTop","topLayerRef","buffer","link","Flow","flowModel","onEvent","setCanvasData","setGrid","setSize","modelRef","current","onLoad","refs","stageRef","stage","_b","zoom","_c","multiSelect","style","position","Provider","value","children","className","transform","concat","default"],"mappings":"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","sourcesContent":["import { __extends, __assign, __decorate } from './node_modules/tslib/tslib.es6.js';\nimport { Group, Circle, Canvas } from '@antv/react-g';\nimport LinkingEdge from './cells/LinkingEdge.js';\nimport React, { useContext, useState, useEffect, createRef } from 'react';\nimport { FlowModel } from './Model.js';\nimport { Renderer } from '@antv/g-canvas';\nimport { observer } from 'mobx-react';\nimport { computed, autorun } from 'mobx';\nimport { FlowContext } from './Context.js';\nimport { registComponents } from './utils/registComponents.js';\nimport SelectBoundsRect from './scaffold/SelectBoundsRect.js';\nimport { initClearState, initLink, initDrag, initSelect, initScale, initMultiSelect, initHotKeys } from './events.js';\nimport { STAGE_CLASS_NAME } from './constants.js';\nimport { getRightClickPanel } from './components/RightClickPanel/index.js';\nimport { color } from './theme/style.js';\n\nvar renderer = new Renderer();\nvar renderComponent = function (cellData, model) {\n    return React.createElement(model.componentsMap.get(cellData.component) || Group, {\n        data: cellData,\n        key: cellData.id,\n    });\n};\nvar Dots = observer(function () {\n    var model = useContext(FlowContext);\n    // const EXTRA = model.grid as number;\n    var EXTRA = 0;\n    var _dots = computed(function () {\n        var re = [];\n        // @TODO\n        for (var i = -EXTRA; i <= model.height() + EXTRA; i += model.grid) {\n            for (var j = -EXTRA; j <= model.width() + EXTRA; j += model.grid) {\n                re.push({\n                    x: j,\n                    y: i,\n                });\n            }\n        }\n        return re;\n    }).get();\n    return (React.createElement(Group, null, _dots.map(function (dot) {\n        return React.createElement(Circle, { x: dot.x, y: dot.y, r: 1, fill: color.deepGrey });\n    })));\n});\nvar Grid = /** @class */ (function (_super) {\n    __extends(Grid, _super);\n    function Grid(props) {\n        var _this = _super.call(this, props) || this;\n        _this.gridRef = React.createRef();\n        return _this;\n    }\n    Grid.prototype.componentDidMount = function () {\n        autorun(function () {\n            // console.log(this.context.width(), this.context.height());\n            // requestAnimationFrame(() => {\n            //   if (this.gridRef.current) {\n            //     this.gridRef.current.isCached() && this.gridRef.current.clearCache();\n            //     this.gridRef.current.cache();\n            //   }\n            // });\n        });\n    };\n    Grid.prototype.render = function () {\n        var _this = this;\n        var grid = this.context.grid;\n        var _gridPos = computed(function () {\n            return {\n                x: -Math.round(_this.context.x() / _this.context.scale() / grid) * grid,\n                y: -Math.round(_this.context.y() / _this.context.scale() / grid) * grid,\n            };\n        }).get();\n        return (React.createElement(Group, __assign({}, _gridPos, { zIndex: 0, ref: this.gridRef, visibility: this.context.grid && this.context.scale() >= 1 ? \"visible\" : \"hidden\" }),\n            React.createElement(Dots, null)));\n    };\n    Grid.contextType = FlowContext;\n    Grid = __decorate([\n        observer\n    ], Grid);\n    return Grid;\n}(React.Component));\nvar Edges = observer(function (props) {\n    var linesLayerRef = props.linesLayerRef, model = props.model;\n    var _a = useState(0); _a[0]; var setSecondRefresh = _a[1];\n    useEffect(function () {\n        setSecondRefresh(1);\n    }, []);\n    var edgesData = model.canvasData.cells.filter(function (cellData) { return cellData.cellType === \"edge\"; });\n    return (React.createElement(Group, { ref: linesLayerRef, zIndex: 1 }, edgesData.map(function (cellData) {\n        return renderComponent(cellData, model);\n    })));\n});\nvar Nodes = observer(function (props) {\n    var nodesLayerRef = props.nodesLayerRef, model = props.model;\n    var nodesData = model.canvasData.cells.filter(function (cellData) {\n        return cellData.cellType !== \"edge\";\n    });\n    return (React.createElement(Group, { ref: nodesLayerRef, zIndex: 2 }, nodesData.slice(0, nodesData.length).map(function (cellData) {\n        return renderComponent(cellData, model);\n    })));\n});\nvar InteractTop = observer(function (props) {\n    var model = props.model, topLayerRef = props.topLayerRef;\n    return (React.createElement(Group, { zIndex: 3, ref: topLayerRef },\n        React.createElement(LinkingEdge, { data: model.buffer.link }),\n        React.createElement(SelectBoundsRect, null)));\n});\nvar Flow = /** @class */ (function (_super) {\n    __extends(Flow, _super);\n    function Flow(props) {\n        var _this = _super.call(this, props) || this;\n        _this.flowModel = new FlowModel(props.onEvent);\n        _this.props.canvasData &&\n            _this.flowModel.setCanvasData(_this.props.canvasData);\n        _this.props.grid && _this.flowModel.setGrid(_this.props.grid);\n        if (_this.props.width && _this.props.height) {\n            _this.flowModel.setSize(_this.props.width, _this.props.height);\n        }\n        props.modelRef && (props.modelRef.current = _this.flowModel);\n        props.onLoad && props.onLoad(_this.flowModel);\n        var refs = _this.flowModel.refs;\n        _this.stageRef = refs.stageRef = createRef();\n        _this.nodesLayerRef = refs.nodesLayerRef = createRef();\n        _this.linesLayerRef = refs.linesLayerRef = createRef();\n        _this.topLayerRef = createRef();\n        registComponents(_this.flowModel);\n        return _this;\n    }\n    Flow.prototype.componentDidMount = function () {\n        var model = this.flowModel;\n        var stage = this.stageRef.current;\n        var _a = this.props, _b = _a.zoom, zoom = _b === void 0 ? true : _b, _c = _a.multiSelect, multiSelect = _c === void 0 ? false : _c;\n        initClearState(model, stage);\n        initLink(model, stage);\n        initDrag(model, stage);\n        initSelect(model);\n        zoom && initScale(model, stage);\n        multiSelect && initMultiSelect(model, stage);\n        initHotKeys(model, stage);\n        initHotKeys(model, stage);\n    };\n    Flow.prototype.render = function () {\n        var model = this.flowModel;\n        return (React.createElement(\"div\", { style: {\n                position: \"relative\",\n            }, id: STAGE_CLASS_NAME },\n            React.createElement(FlowContext.Provider, { value: model },\n                getRightClickPanel(this.props.children),\n                React.createElement(Canvas, { renderer: renderer, className: STAGE_CLASS_NAME, ref: this.stageRef, width: model.width(), height: model.height() },\n                    React.createElement(Group, { transform: \"scale(\".concat(model.scale(), \", \").concat(model.scale(), \")\"), x: model.x(), y: model.y() },\n                        React.createElement(FlowContext.Provider, { value: model },\n                            this.props.grid && React.createElement(Grid, null),\n                            React.createElement(Nodes, { nodesLayerRef: this.nodesLayerRef, model: model }),\n                            React.createElement(Edges, { linesLayerRef: this.linesLayerRef, model: model }),\n                            React.createElement(InteractTop, { topLayerRef: this.topLayerRef, model: model })))))));\n    };\n    Flow = __decorate([\n        observer\n    ], Flow);\n    return Flow;\n}(React.Component));\n\nexport { Flow as default };\n"]},"metadata":{},"sourceType":"module"}