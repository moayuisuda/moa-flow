{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { GlobalContainer } from 'mana-syringe';\nimport { requestAnimationFrame as rAF, cancelAnimationFrame as cancelRAF } from 'request-animation-frame-polyfill';\nimport { CanvasConfig } from './types';\nimport { cleanExistedCanvas, isBrowser } from './utils/canvas';\nimport { DisplayObject } from './display-objects/DisplayObject';\nimport { ContextService } from './services';\nimport { RenderingService } from './services/RenderingService';\nimport { RenderingContext, RenderReason } from './services/RenderingContext';\nimport { EventService } from './services/EventService';\nimport { Camera, CameraEvent, CameraProjectionMode, DefaultCamera } from './camera';\nimport { containerModule as commonContainerModule } from './canvas-module';\nimport { Document, EventTarget, ElementEvent } from './dom';\nimport { CustomElementRegistry } from './dom/CustomElementRegistry';\nexport var CanvasEvent;\n\n(function (CanvasEvent) {\n  CanvasEvent[\"READY\"] = \"ready\";\n  CanvasEvent[\"BEFORE_RENDER\"] = \"beforerender\";\n  CanvasEvent[\"AFTER_RENDER\"] = \"afterrender\";\n  CanvasEvent[\"BEFORE_DESTROY\"] = \"beforedestroy\";\n  CanvasEvent[\"AFTER_DESTROY\"] = \"afterdestroy\";\n  CanvasEvent[\"RESIZE\"] = \"resize\";\n})(CanvasEvent || (CanvasEvent = {}));\n/**\n * can be treated like Window in DOM\n * provide some extra methods like `window`, such as:\n * * `window.requestAnimationFrame`\n * * `window.devicePixelRatio`\n *\n * prototype chains: Canvas(Window) -> EventTarget\n */\n\n\nvar Canvas =\n/** @class */\nfunction (_super) {\n  __extends(Canvas, _super);\n\n  function Canvas(config) {\n    var _this = _super.call(this) || this;\n    /**\n     * child container of current canvas, use hierarchy container\n     */\n\n\n    _this.container = GlobalContainer.createChild();\n    /**\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/Element\n     */\n\n    _this.Element = DisplayObject;\n    _this.inited = false; // create document\n\n    _this.document = new Document();\n    _this.document.defaultView = _this; // create registry of custom elements\n\n    _this.customElements = new CustomElementRegistry();\n    var container = config.container,\n        canvas = config.canvas,\n        offscreenCanvas = config.offscreenCanvas,\n        width = config.width,\n        height = config.height,\n        devicePixelRatio = config.devicePixelRatio,\n        renderer = config.renderer,\n        background = config.background,\n        requestAnimationFrame = config.requestAnimationFrame,\n        cancelAnimationFrame = config.cancelAnimationFrame,\n        createImage = config.createImage,\n        supportPointerEvent = config.supportPointerEvent,\n        supportTouchEvent = config.supportTouchEvent,\n        isTouchEvent = config.isTouchEvent,\n        isMouseEvent = config.isMouseEvent;\n    cleanExistedCanvas(container, _this);\n    var canvasWidth = width;\n    var canvasHeight = height;\n    var dpr = devicePixelRatio; // use user-defined <canvas> or OffscreenCanvas\n\n    if (canvas) {\n      // infer width & height with dpr\n      dpr = devicePixelRatio || isBrowser && window.devicePixelRatio || 1;\n      dpr = dpr >= 1 ? Math.ceil(dpr) : 1;\n      canvasWidth = width || canvas.width / dpr;\n      canvasHeight = height || canvas.height / dpr;\n    }\n    /**\n     * implements `Window` interface\n     */\n\n\n    _this.devicePixelRatio = dpr;\n    _this.requestAnimationFrame = requestAnimationFrame !== null && requestAnimationFrame !== void 0 ? requestAnimationFrame : rAF.bind(globalThis);\n    _this.cancelAnimationFrame = cancelAnimationFrame !== null && cancelAnimationFrame !== void 0 ? cancelAnimationFrame : cancelRAF.bind(globalThis);\n    /**\n     * limits query\n     */\n\n    _this.supportTouchEvent = supportTouchEvent !== null && supportTouchEvent !== void 0 ? supportTouchEvent : 'ontouchstart' in globalThis;\n    _this.supportPointerEvent = supportPointerEvent !== null && supportPointerEvent !== void 0 ? supportPointerEvent : !!globalThis.PointerEvent;\n    _this.isTouchEvent = isTouchEvent !== null && isTouchEvent !== void 0 ? isTouchEvent : function (event) {\n      return _this.supportTouchEvent && event instanceof globalThis.TouchEvent;\n    };\n    _this.isMouseEvent = isMouseEvent !== null && isMouseEvent !== void 0 ? isMouseEvent : function (event) {\n      return !globalThis.MouseEvent || event instanceof globalThis.MouseEvent && (!_this.supportPointerEvent || !(event instanceof globalThis.PointerEvent));\n    };\n\n    _this.initRenderingContext({\n      container: container,\n      canvas: canvas,\n      width: canvasWidth,\n      height: canvasHeight,\n      renderer: renderer,\n      offscreenCanvas: offscreenCanvas,\n      devicePixelRatio: dpr,\n      cursor: 'default',\n      background: background,\n      createImage: createImage\n    });\n\n    _this.initDefaultCamera(canvasWidth, canvasHeight);\n\n    _this.initRenderer(renderer);\n\n    return _this;\n  }\n\n  Canvas.prototype.initRenderingContext = function (mergedConfig) {\n    var _this = this;\n\n    this.container.register({\n      token: CanvasConfig,\n      useValue: mergedConfig\n    }); // bind rendering context, shared by all renderers\n\n    this.container.register({\n      token: RenderingContext,\n      useValue: {\n        /**\n         * the root node in scene graph\n         */\n        root: this.document.documentElement,\n        renderReasons: new Set(),\n        force: false,\n        dirty: false\n      }\n    });\n    this.document.documentElement.addEventListener(ElementEvent.CHILD_INSERTED, function (e) {\n      _this.mountChildren(e.detail.child);\n    });\n    this.document.documentElement.addEventListener(ElementEvent.CHILD_REMOVED, function (e) {\n      _this.unmountChildren(e.detail.child);\n    });\n  };\n\n  Canvas.prototype.initDefaultCamera = function (width, height) {\n    // set a default ortho camera\n    var camera = new Camera().setPosition(width / 2, height / 2, 500).setFocalPoint(width / 2, height / 2, 0).setOrthographic(width / -2, width / 2, height / 2, height / -2, 0.1, 1000); // keep ref since it will use raf in camera animation\n\n    camera.canvas = this; // redraw when camera changed\n\n    var context = this.container.get(RenderingContext);\n    camera.on(CameraEvent.UPDATED, function () {\n      context.renderReasons.add(RenderReason.CAMERA_CHANGED);\n    }); // bind camera\n\n    this.container.register({\n      token: DefaultCamera,\n      useValue: camera\n    });\n  };\n\n  Canvas.prototype.getConfig = function () {\n    return this.container.get(CanvasConfig);\n  };\n\n  Canvas.prototype.getContainer = function () {\n    return this.container;\n  };\n  /**\n   * get the root displayObject in scenegraph\n   * @alias this.document.documentElement\n   */\n\n\n  Canvas.prototype.getRoot = function () {\n    return this.document.documentElement;\n  };\n  /**\n   * get the camera of canvas\n   */\n\n\n  Canvas.prototype.getCamera = function () {\n    return this.container.get(DefaultCamera);\n  };\n\n  Canvas.prototype.getContextService = function () {\n    return this.container.get(ContextService);\n  };\n\n  Canvas.prototype.getEventService = function () {\n    return this.eventService;\n  };\n\n  Canvas.prototype.getRenderingService = function () {\n    return this.renderingService;\n  };\n\n  Canvas.prototype.getRenderingContext = function () {\n    return this.container.get(RenderingContext);\n  };\n\n  Canvas.prototype.getStats = function () {\n    return this.getRenderingService().getStats();\n  };\n\n  Object.defineProperty(Canvas.prototype, \"ready\", {\n    // /**\n    //  * @see https://developer.mozilla.org/zh-CN/docs/Web/API/Window/getComputedStyle\n    //  */\n    // getComputedStyle(node: DisplayObject) {\n    //   return node.computedStyle;\n    // }\n    get: function get() {\n      var _this = this;\n\n      if (!this.readyPromise) {\n        this.readyPromise = new Promise(function (resolve) {\n          _this.resolveReadyPromise = function () {\n            resolve(_this);\n          };\n        });\n\n        if (this.inited) {\n          this.resolveReadyPromise();\n        }\n      }\n\n      return this.readyPromise;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  Canvas.prototype.destroy = function (destroyScenegraph) {\n    if (destroyScenegraph === void 0) {\n      destroyScenegraph = true;\n    }\n\n    this.emit(CanvasEvent.BEFORE_DESTROY, function () {});\n\n    if (this.frameId) {\n      var cancelRAF_1 = this.getConfig().cancelAnimationFrame || cancelAnimationFrame;\n      cancelRAF_1(this.frameId);\n    } // unmount all children\n\n\n    var root = this.getRoot();\n    this.unmountChildren(root); // root.children.forEach((child: DisplayObject) => {\n    //   this.unmountChildren(child);\n    // });\n\n    if (destroyScenegraph) {\n      // destroy Document\n      this.document.destroy();\n    } // destroy services\n\n\n    this.getContextService().destroy();\n    this.getRenderingService().destroy();\n    this.emit(CanvasEvent.AFTER_DESTROY, {});\n  };\n  /**\n   * compatible with G 3.0\n   * @deprecated\n   * @alias resize\n   */\n\n\n  Canvas.prototype.changeSize = function (width, height) {\n    this.resize(width, height);\n  };\n\n  Canvas.prototype.resize = function (width, height) {\n    // update canvas' config\n    var canvasConfig = this.container.get(CanvasConfig);\n    canvasConfig.width = width;\n    canvasConfig.height = height; // resize context\n\n    this.getContextService().resize(width, height); // resize camera\n\n    var camera = this.container.get(DefaultCamera);\n    var projectionMode = camera.getProjectionMode();\n    camera.setPosition(width / 2, height / 2, 500).setFocalPoint(width / 2, height / 2, 0);\n\n    if (projectionMode === CameraProjectionMode.ORTHOGRAPHIC) {\n      camera.setOrthographic(width / -2, width / 2, height / 2, height / -2, camera.getNear(), camera.getFar());\n    } else {\n      camera.setAspect(width / height);\n    }\n\n    this.emit(CanvasEvent.RESIZE, {\n      width: width,\n      height: height\n    });\n  }; // proxy to document.documentElement\n\n\n  Canvas.prototype.appendChild = function (child, index) {\n    return this.document.documentElement.appendChild(child, index);\n  };\n\n  Canvas.prototype.insertBefore = function (newChild, refChild) {\n    return this.document.documentElement.insertBefore(newChild, refChild);\n  };\n\n  Canvas.prototype.removeChild = function (child, destroy) {\n    if (destroy === void 0) {\n      destroy = true;\n    }\n\n    return this.document.documentElement.removeChild(child, destroy);\n  };\n\n  Canvas.prototype.removeChildren = function (destroy) {\n    if (destroy === void 0) {\n      destroy = true;\n    }\n\n    this.document.documentElement.removeChildren(destroy);\n  };\n\n  Canvas.prototype.render = function () {\n    this.emit(CanvasEvent.BEFORE_RENDER, {});\n\n    if (this.container.isBound(RenderingService)) {\n      var renderingService = this.container.get(RenderingService);\n      renderingService.render(this.getConfig());\n    }\n\n    this.emit(CanvasEvent.AFTER_RENDER, {});\n  };\n\n  Canvas.prototype.run = function () {\n    var _this = this;\n\n    var tick = function tick() {\n      _this.render();\n\n      _this.frameId = requestAnimationFrame(tick);\n    };\n\n    tick();\n  };\n\n  Canvas.prototype.initRenderer = function (renderer) {\n    var _this = this;\n\n    if (!renderer) {\n      throw new Error('Renderer is required.');\n    } // reset\n\n\n    this.inited = false;\n    this.readyPromise = undefined;\n    this.loadCommonContainerModule();\n    this.loadRendererContainerModule(renderer); // init context\n\n    var contextService = this.container.get(ContextService);\n    this.renderingService = this.container.get(RenderingService);\n    this.eventService = this.container.get(EventService);\n    contextService.init();\n    this.renderingService.init().then(function () {\n      _this.emit(CanvasEvent.READY, {});\n\n      if (_this.readyPromise) {\n        _this.resolveReadyPromise();\n      }\n\n      _this.inited = true;\n    });\n\n    if (renderer.getConfig().enableAutoRendering) {\n      this.run();\n    }\n\n    this.getRoot().forEach(function (node) {\n      var renderable = node.renderable;\n\n      if (renderable) {\n        renderable.renderBoundsDirty = true;\n        renderable.boundsDirty = true;\n        renderable.dirty = true;\n      }\n    }); // keep current scenegraph unchanged, just trigger mounted event\n\n    this.mountChildren(this.getRoot());\n  };\n\n  Canvas.prototype.loadCommonContainerModule = function () {\n    this.container.unload(commonContainerModule);\n    this.container.load(commonContainerModule, true);\n  };\n\n  Canvas.prototype.loadRendererContainerModule = function (renderer) {\n    var _this = this; // load other container modules provided by g-canvas/g-svg/g-webgl\n\n\n    var plugins = renderer.getPlugins();\n    plugins.forEach(function (plugin) {\n      plugin.init(_this.container);\n    });\n  };\n\n  Canvas.prototype.setRenderer = function (renderer) {\n    var _this = this; // update canvas' config\n\n\n    var canvasConfig = this.getConfig();\n\n    if (canvasConfig.renderer === renderer) {\n      return;\n    }\n\n    var oldRenderer = canvasConfig.renderer;\n    canvasConfig.renderer = renderer; // keep all children undestroyed\n\n    this.destroy(false); // destroy all plugins\n\n    oldRenderer === null || oldRenderer === void 0 ? void 0 : oldRenderer.getPlugins().reverse().forEach(function (plugin) {\n      plugin.destroy(_this.container);\n    });\n    this.initRenderer(renderer);\n  };\n\n  Canvas.prototype.setCursor = function (cursor) {\n    this.getContextService().applyCursorStyle(cursor);\n  };\n\n  Canvas.prototype.unmountChildren = function (parent) {\n    var _this = this;\n\n    var path = [];\n    parent.forEach(function (child) {\n      if (child.isConnected) {\n        path.push(child);\n      }\n    }); // unmount from leaf to root\n\n    path.reverse().forEach(function (child) {\n      child.emit(ElementEvent.UNMOUNTED, {}); // skip document.documentElement\n\n      if (child !== _this.document.documentElement) {\n        child.ownerDocument = null;\n      }\n\n      child.isConnected = false;\n    });\n  };\n\n  Canvas.prototype.mountChildren = function (parent) {\n    var _this = this;\n\n    parent.forEach(function (child) {\n      if (!child.isConnected) {\n        child.ownerDocument = _this.document;\n        child.isConnected = true;\n        child.emit(ElementEvent.MOUNTED, {});\n      }\n    });\n  };\n\n  Canvas.prototype.client2Viewport = function (client) {\n    return this.getEventService().client2Viewport(client);\n  };\n\n  Canvas.prototype.viewport2Client = function (canvas) {\n    return this.getEventService().viewport2Client(canvas);\n  };\n\n  Canvas.prototype.viewport2Canvas = function (viewport) {\n    return this.getEventService().viewport2Canvas(viewport);\n  };\n\n  Canvas.prototype.canvas2Viewport = function (canvas) {\n    return this.getEventService().canvas2Viewport(canvas);\n  };\n  /**\n   * @deprecated\n   * @alias client2Viewport\n   */\n\n\n  Canvas.prototype.getPointByClient = function (clientX, clientY) {\n    return this.client2Viewport({\n      x: clientX,\n      y: clientY\n    });\n  };\n  /**\n   * @deprecated\n   * @alias viewport2Client\n   */\n\n\n  Canvas.prototype.getClientByPoint = function (x, y) {\n    return this.viewport2Client({\n      x: x,\n      y: y\n    });\n  };\n\n  return Canvas;\n}(EventTarget);\n\nexport { Canvas };","map":{"version":3,"sources":["/Users/dennis.zhang/Desktop/其它代码库/moa-flow/node_modules/@antv/g/es/Canvas.js"],"names":["__extends","GlobalContainer","requestAnimationFrame","rAF","cancelAnimationFrame","cancelRAF","CanvasConfig","cleanExistedCanvas","isBrowser","DisplayObject","ContextService","RenderingService","RenderingContext","RenderReason","EventService","Camera","CameraEvent","CameraProjectionMode","DefaultCamera","containerModule","commonContainerModule","Document","EventTarget","ElementEvent","CustomElementRegistry","CanvasEvent","Canvas","_super","config","_this","call","container","createChild","Element","inited","document","defaultView","customElements","canvas","offscreenCanvas","width","height","devicePixelRatio","renderer","background","createImage","supportPointerEvent","supportTouchEvent","isTouchEvent","isMouseEvent","canvasWidth","canvasHeight","dpr","window","Math","ceil","bind","globalThis","PointerEvent","event","TouchEvent","MouseEvent","initRenderingContext","cursor","initDefaultCamera","initRenderer","prototype","mergedConfig","register","token","useValue","root","documentElement","renderReasons","Set","force","dirty","addEventListener","CHILD_INSERTED","e","mountChildren","detail","child","CHILD_REMOVED","unmountChildren","camera","setPosition","setFocalPoint","setOrthographic","context","get","on","UPDATED","add","CAMERA_CHANGED","getConfig","getContainer","getRoot","getCamera","getContextService","getEventService","eventService","getRenderingService","renderingService","getRenderingContext","getStats","Object","defineProperty","readyPromise","Promise","resolve","resolveReadyPromise","enumerable","configurable","destroy","destroyScenegraph","emit","BEFORE_DESTROY","frameId","cancelRAF_1","AFTER_DESTROY","changeSize","resize","canvasConfig","projectionMode","getProjectionMode","ORTHOGRAPHIC","getNear","getFar","setAspect","RESIZE","appendChild","index","insertBefore","newChild","refChild","removeChild","removeChildren","render","BEFORE_RENDER","isBound","AFTER_RENDER","run","tick","Error","undefined","loadCommonContainerModule","loadRendererContainerModule","contextService","init","then","READY","enableAutoRendering","forEach","node","renderable","renderBoundsDirty","boundsDirty","unload","load","plugins","getPlugins","plugin","setRenderer","oldRenderer","reverse","setCursor","applyCursorStyle","parent","path","isConnected","push","UNMOUNTED","ownerDocument","MOUNTED","client2Viewport","client","viewport2Client","viewport2Canvas","viewport","canvas2Viewport","getPointByClient","clientX","clientY","x","y","getClientByPoint"],"mappings":"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","sourcesContent":["import { __extends } from \"tslib\";\nimport { GlobalContainer } from 'mana-syringe';\nimport { requestAnimationFrame as rAF, cancelAnimationFrame as cancelRAF } from 'request-animation-frame-polyfill';\nimport { CanvasConfig } from './types';\nimport { cleanExistedCanvas, isBrowser } from './utils/canvas';\nimport { DisplayObject } from './display-objects/DisplayObject';\nimport { ContextService } from './services';\nimport { RenderingService } from './services/RenderingService';\nimport { RenderingContext, RenderReason } from './services/RenderingContext';\nimport { EventService } from './services/EventService';\nimport { Camera, CameraEvent, CameraProjectionMode, DefaultCamera } from './camera';\nimport { containerModule as commonContainerModule } from './canvas-module';\nimport { Document, EventTarget, ElementEvent } from './dom';\nimport { CustomElementRegistry } from './dom/CustomElementRegistry';\nexport var CanvasEvent;\n\n(function (CanvasEvent) {\n  CanvasEvent[\"READY\"] = \"ready\";\n  CanvasEvent[\"BEFORE_RENDER\"] = \"beforerender\";\n  CanvasEvent[\"AFTER_RENDER\"] = \"afterrender\";\n  CanvasEvent[\"BEFORE_DESTROY\"] = \"beforedestroy\";\n  CanvasEvent[\"AFTER_DESTROY\"] = \"afterdestroy\";\n  CanvasEvent[\"RESIZE\"] = \"resize\";\n})(CanvasEvent || (CanvasEvent = {}));\n/**\n * can be treated like Window in DOM\n * provide some extra methods like `window`, such as:\n * * `window.requestAnimationFrame`\n * * `window.devicePixelRatio`\n *\n * prototype chains: Canvas(Window) -> EventTarget\n */\n\n\nvar Canvas =\n/** @class */\nfunction (_super) {\n  __extends(Canvas, _super);\n\n  function Canvas(config) {\n    var _this = _super.call(this) || this;\n    /**\n     * child container of current canvas, use hierarchy container\n     */\n\n\n    _this.container = GlobalContainer.createChild();\n    /**\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/Element\n     */\n\n    _this.Element = DisplayObject;\n    _this.inited = false; // create document\n\n    _this.document = new Document();\n    _this.document.defaultView = _this; // create registry of custom elements\n\n    _this.customElements = new CustomElementRegistry();\n    var container = config.container,\n        canvas = config.canvas,\n        offscreenCanvas = config.offscreenCanvas,\n        width = config.width,\n        height = config.height,\n        devicePixelRatio = config.devicePixelRatio,\n        renderer = config.renderer,\n        background = config.background,\n        requestAnimationFrame = config.requestAnimationFrame,\n        cancelAnimationFrame = config.cancelAnimationFrame,\n        createImage = config.createImage,\n        supportPointerEvent = config.supportPointerEvent,\n        supportTouchEvent = config.supportTouchEvent,\n        isTouchEvent = config.isTouchEvent,\n        isMouseEvent = config.isMouseEvent;\n    cleanExistedCanvas(container, _this);\n    var canvasWidth = width;\n    var canvasHeight = height;\n    var dpr = devicePixelRatio; // use user-defined <canvas> or OffscreenCanvas\n\n    if (canvas) {\n      // infer width & height with dpr\n      dpr = devicePixelRatio || isBrowser && window.devicePixelRatio || 1;\n      dpr = dpr >= 1 ? Math.ceil(dpr) : 1;\n      canvasWidth = width || canvas.width / dpr;\n      canvasHeight = height || canvas.height / dpr;\n    }\n    /**\n     * implements `Window` interface\n     */\n\n\n    _this.devicePixelRatio = dpr;\n    _this.requestAnimationFrame = requestAnimationFrame !== null && requestAnimationFrame !== void 0 ? requestAnimationFrame : rAF.bind(globalThis);\n    _this.cancelAnimationFrame = cancelAnimationFrame !== null && cancelAnimationFrame !== void 0 ? cancelAnimationFrame : cancelRAF.bind(globalThis);\n    /**\n     * limits query\n     */\n\n    _this.supportTouchEvent = supportTouchEvent !== null && supportTouchEvent !== void 0 ? supportTouchEvent : 'ontouchstart' in globalThis;\n    _this.supportPointerEvent = supportPointerEvent !== null && supportPointerEvent !== void 0 ? supportPointerEvent : !!globalThis.PointerEvent;\n    _this.isTouchEvent = isTouchEvent !== null && isTouchEvent !== void 0 ? isTouchEvent : function (event) {\n      return _this.supportTouchEvent && event instanceof globalThis.TouchEvent;\n    };\n    _this.isMouseEvent = isMouseEvent !== null && isMouseEvent !== void 0 ? isMouseEvent : function (event) {\n      return !globalThis.MouseEvent || event instanceof globalThis.MouseEvent && (!_this.supportPointerEvent || !(event instanceof globalThis.PointerEvent));\n    };\n\n    _this.initRenderingContext({\n      container: container,\n      canvas: canvas,\n      width: canvasWidth,\n      height: canvasHeight,\n      renderer: renderer,\n      offscreenCanvas: offscreenCanvas,\n      devicePixelRatio: dpr,\n      cursor: 'default',\n      background: background,\n      createImage: createImage\n    });\n\n    _this.initDefaultCamera(canvasWidth, canvasHeight);\n\n    _this.initRenderer(renderer);\n\n    return _this;\n  }\n\n  Canvas.prototype.initRenderingContext = function (mergedConfig) {\n    var _this = this;\n\n    this.container.register({\n      token: CanvasConfig,\n      useValue: mergedConfig\n    }); // bind rendering context, shared by all renderers\n\n    this.container.register({\n      token: RenderingContext,\n      useValue: {\n        /**\n         * the root node in scene graph\n         */\n        root: this.document.documentElement,\n        renderReasons: new Set(),\n        force: false,\n        dirty: false\n      }\n    });\n    this.document.documentElement.addEventListener(ElementEvent.CHILD_INSERTED, function (e) {\n      _this.mountChildren(e.detail.child);\n    });\n    this.document.documentElement.addEventListener(ElementEvent.CHILD_REMOVED, function (e) {\n      _this.unmountChildren(e.detail.child);\n    });\n  };\n\n  Canvas.prototype.initDefaultCamera = function (width, height) {\n    // set a default ortho camera\n    var camera = new Camera().setPosition(width / 2, height / 2, 500).setFocalPoint(width / 2, height / 2, 0).setOrthographic(width / -2, width / 2, height / 2, height / -2, 0.1, 1000); // keep ref since it will use raf in camera animation\n\n    camera.canvas = this; // redraw when camera changed\n\n    var context = this.container.get(RenderingContext);\n    camera.on(CameraEvent.UPDATED, function () {\n      context.renderReasons.add(RenderReason.CAMERA_CHANGED);\n    }); // bind camera\n\n    this.container.register({\n      token: DefaultCamera,\n      useValue: camera\n    });\n  };\n\n  Canvas.prototype.getConfig = function () {\n    return this.container.get(CanvasConfig);\n  };\n\n  Canvas.prototype.getContainer = function () {\n    return this.container;\n  };\n  /**\n   * get the root displayObject in scenegraph\n   * @alias this.document.documentElement\n   */\n\n\n  Canvas.prototype.getRoot = function () {\n    return this.document.documentElement;\n  };\n  /**\n   * get the camera of canvas\n   */\n\n\n  Canvas.prototype.getCamera = function () {\n    return this.container.get(DefaultCamera);\n  };\n\n  Canvas.prototype.getContextService = function () {\n    return this.container.get(ContextService);\n  };\n\n  Canvas.prototype.getEventService = function () {\n    return this.eventService;\n  };\n\n  Canvas.prototype.getRenderingService = function () {\n    return this.renderingService;\n  };\n\n  Canvas.prototype.getRenderingContext = function () {\n    return this.container.get(RenderingContext);\n  };\n\n  Canvas.prototype.getStats = function () {\n    return this.getRenderingService().getStats();\n  };\n\n  Object.defineProperty(Canvas.prototype, \"ready\", {\n    // /**\n    //  * @see https://developer.mozilla.org/zh-CN/docs/Web/API/Window/getComputedStyle\n    //  */\n    // getComputedStyle(node: DisplayObject) {\n    //   return node.computedStyle;\n    // }\n    get: function get() {\n      var _this = this;\n\n      if (!this.readyPromise) {\n        this.readyPromise = new Promise(function (resolve) {\n          _this.resolveReadyPromise = function () {\n            resolve(_this);\n          };\n        });\n\n        if (this.inited) {\n          this.resolveReadyPromise();\n        }\n      }\n\n      return this.readyPromise;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  Canvas.prototype.destroy = function (destroyScenegraph) {\n    if (destroyScenegraph === void 0) {\n      destroyScenegraph = true;\n    }\n\n    this.emit(CanvasEvent.BEFORE_DESTROY, function () {});\n\n    if (this.frameId) {\n      var cancelRAF_1 = this.getConfig().cancelAnimationFrame || cancelAnimationFrame;\n      cancelRAF_1(this.frameId);\n    } // unmount all children\n\n\n    var root = this.getRoot();\n    this.unmountChildren(root); // root.children.forEach((child: DisplayObject) => {\n    //   this.unmountChildren(child);\n    // });\n\n    if (destroyScenegraph) {\n      // destroy Document\n      this.document.destroy();\n    } // destroy services\n\n\n    this.getContextService().destroy();\n    this.getRenderingService().destroy();\n    this.emit(CanvasEvent.AFTER_DESTROY, {});\n  };\n  /**\n   * compatible with G 3.0\n   * @deprecated\n   * @alias resize\n   */\n\n\n  Canvas.prototype.changeSize = function (width, height) {\n    this.resize(width, height);\n  };\n\n  Canvas.prototype.resize = function (width, height) {\n    // update canvas' config\n    var canvasConfig = this.container.get(CanvasConfig);\n    canvasConfig.width = width;\n    canvasConfig.height = height; // resize context\n\n    this.getContextService().resize(width, height); // resize camera\n\n    var camera = this.container.get(DefaultCamera);\n    var projectionMode = camera.getProjectionMode();\n    camera.setPosition(width / 2, height / 2, 500).setFocalPoint(width / 2, height / 2, 0);\n\n    if (projectionMode === CameraProjectionMode.ORTHOGRAPHIC) {\n      camera.setOrthographic(width / -2, width / 2, height / 2, height / -2, camera.getNear(), camera.getFar());\n    } else {\n      camera.setAspect(width / height);\n    }\n\n    this.emit(CanvasEvent.RESIZE, {\n      width: width,\n      height: height\n    });\n  }; // proxy to document.documentElement\n\n\n  Canvas.prototype.appendChild = function (child, index) {\n    return this.document.documentElement.appendChild(child, index);\n  };\n\n  Canvas.prototype.insertBefore = function (newChild, refChild) {\n    return this.document.documentElement.insertBefore(newChild, refChild);\n  };\n\n  Canvas.prototype.removeChild = function (child, destroy) {\n    if (destroy === void 0) {\n      destroy = true;\n    }\n\n    return this.document.documentElement.removeChild(child, destroy);\n  };\n\n  Canvas.prototype.removeChildren = function (destroy) {\n    if (destroy === void 0) {\n      destroy = true;\n    }\n\n    this.document.documentElement.removeChildren(destroy);\n  };\n\n  Canvas.prototype.render = function () {\n    this.emit(CanvasEvent.BEFORE_RENDER, {});\n\n    if (this.container.isBound(RenderingService)) {\n      var renderingService = this.container.get(RenderingService);\n      renderingService.render(this.getConfig());\n    }\n\n    this.emit(CanvasEvent.AFTER_RENDER, {});\n  };\n\n  Canvas.prototype.run = function () {\n    var _this = this;\n\n    var tick = function tick() {\n      _this.render();\n\n      _this.frameId = requestAnimationFrame(tick);\n    };\n\n    tick();\n  };\n\n  Canvas.prototype.initRenderer = function (renderer) {\n    var _this = this;\n\n    if (!renderer) {\n      throw new Error('Renderer is required.');\n    } // reset\n\n\n    this.inited = false;\n    this.readyPromise = undefined;\n    this.loadCommonContainerModule();\n    this.loadRendererContainerModule(renderer); // init context\n\n    var contextService = this.container.get(ContextService);\n    this.renderingService = this.container.get(RenderingService);\n    this.eventService = this.container.get(EventService);\n    contextService.init();\n    this.renderingService.init().then(function () {\n      _this.emit(CanvasEvent.READY, {});\n\n      if (_this.readyPromise) {\n        _this.resolveReadyPromise();\n      }\n\n      _this.inited = true;\n    });\n\n    if (renderer.getConfig().enableAutoRendering) {\n      this.run();\n    }\n\n    this.getRoot().forEach(function (node) {\n      var renderable = node.renderable;\n\n      if (renderable) {\n        renderable.renderBoundsDirty = true;\n        renderable.boundsDirty = true;\n        renderable.dirty = true;\n      }\n    }); // keep current scenegraph unchanged, just trigger mounted event\n\n    this.mountChildren(this.getRoot());\n  };\n\n  Canvas.prototype.loadCommonContainerModule = function () {\n    this.container.unload(commonContainerModule);\n    this.container.load(commonContainerModule, true);\n  };\n\n  Canvas.prototype.loadRendererContainerModule = function (renderer) {\n    var _this = this; // load other container modules provided by g-canvas/g-svg/g-webgl\n\n\n    var plugins = renderer.getPlugins();\n    plugins.forEach(function (plugin) {\n      plugin.init(_this.container);\n    });\n  };\n\n  Canvas.prototype.setRenderer = function (renderer) {\n    var _this = this; // update canvas' config\n\n\n    var canvasConfig = this.getConfig();\n\n    if (canvasConfig.renderer === renderer) {\n      return;\n    }\n\n    var oldRenderer = canvasConfig.renderer;\n    canvasConfig.renderer = renderer; // keep all children undestroyed\n\n    this.destroy(false); // destroy all plugins\n\n    oldRenderer === null || oldRenderer === void 0 ? void 0 : oldRenderer.getPlugins().reverse().forEach(function (plugin) {\n      plugin.destroy(_this.container);\n    });\n    this.initRenderer(renderer);\n  };\n\n  Canvas.prototype.setCursor = function (cursor) {\n    this.getContextService().applyCursorStyle(cursor);\n  };\n\n  Canvas.prototype.unmountChildren = function (parent) {\n    var _this = this;\n\n    var path = [];\n    parent.forEach(function (child) {\n      if (child.isConnected) {\n        path.push(child);\n      }\n    }); // unmount from leaf to root\n\n    path.reverse().forEach(function (child) {\n      child.emit(ElementEvent.UNMOUNTED, {}); // skip document.documentElement\n\n      if (child !== _this.document.documentElement) {\n        child.ownerDocument = null;\n      }\n\n      child.isConnected = false;\n    });\n  };\n\n  Canvas.prototype.mountChildren = function (parent) {\n    var _this = this;\n\n    parent.forEach(function (child) {\n      if (!child.isConnected) {\n        child.ownerDocument = _this.document;\n        child.isConnected = true;\n        child.emit(ElementEvent.MOUNTED, {});\n      }\n    });\n  };\n\n  Canvas.prototype.client2Viewport = function (client) {\n    return this.getEventService().client2Viewport(client);\n  };\n\n  Canvas.prototype.viewport2Client = function (canvas) {\n    return this.getEventService().viewport2Client(canvas);\n  };\n\n  Canvas.prototype.viewport2Canvas = function (viewport) {\n    return this.getEventService().viewport2Canvas(viewport);\n  };\n\n  Canvas.prototype.canvas2Viewport = function (canvas) {\n    return this.getEventService().canvas2Viewport(canvas);\n  };\n  /**\n   * @deprecated\n   * @alias client2Viewport\n   */\n\n\n  Canvas.prototype.getPointByClient = function (clientX, clientY) {\n    return this.client2Viewport({\n      x: clientX,\n      y: clientY\n    });\n  };\n  /**\n   * @deprecated\n   * @alias viewport2Client\n   */\n\n\n  Canvas.prototype.getClientByPoint = function (x, y) {\n    return this.viewport2Client({\n      x: x,\n      y: y\n    });\n  };\n\n  return Canvas;\n}(EventTarget);\n\nexport { Canvas };"]},"metadata":{},"sourceType":"module"}