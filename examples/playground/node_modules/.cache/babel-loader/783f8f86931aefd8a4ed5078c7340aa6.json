{"ast":null,"code":"import { __awaiter, __decorate, __generator, __metadata, __values } from \"tslib\";\nimport { inject, singleton } from 'mana-syringe';\nimport { isUndefined } from 'lodash-es';\nimport { FederatedPointerEvent } from '../dom/FederatedPointerEvent';\nimport { FederatedWheelEvent } from '../dom/FederatedWheelEvent';\nimport { RenderingContext } from '../services';\nimport { ContextService, RenderingService, EventService, RenderingPluginContribution } from '../services';\nimport { Point } from '../shapes';\nimport { CanvasConfig } from '../types';\nimport { MOUSE_POINTER_ID, TOUCH_TO_POINTER } from '../utils/event';\n/**\n * support mouse & touch events\n * @see https://github.com/pixijs/pixi.js/blob/dev/packages/interaction/README.md\n *\n * also provide some extra events such as `drag`\n */\n\nvar EventPlugin =\n/** @class */\nfunction () {\n  function EventPlugin() {\n    var _this = this;\n\n    this.autoPreventDefault = true;\n    this.rootPointerEvent = new FederatedPointerEvent(null);\n    this.rootWheelEvent = new FederatedWheelEvent(null);\n\n    this.onPointerMove = function (nativeEvent) {\n      var e_1, _a;\n\n      var _b, _c;\n\n      var canvas = (_c = (_b = _this.renderingContext.root) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.defaultView;\n      if (canvas.supportTouchEvent && nativeEvent.pointerType === 'touch') return;\n\n      var normalizedEvents = _this.normalizeToPointerEvent(nativeEvent, canvas);\n\n      try {\n        for (var normalizedEvents_1 = __values(normalizedEvents), normalizedEvents_1_1 = normalizedEvents_1.next(); !normalizedEvents_1_1.done; normalizedEvents_1_1 = normalizedEvents_1.next()) {\n          var normalizedEvent = normalizedEvents_1_1.value;\n\n          var event_1 = _this.bootstrapEvent(_this.rootPointerEvent, normalizedEvent, canvas);\n\n          _this.eventService.mapEvent(event_1);\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (normalizedEvents_1_1 && !normalizedEvents_1_1.done && (_a = normalizedEvents_1.return)) _a.call(normalizedEvents_1);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n\n      _this.setCursor(_this.eventService.cursor);\n    };\n  }\n\n  EventPlugin_1 = EventPlugin;\n\n  EventPlugin.prototype.apply = function (renderingService) {\n    var _this = this;\n\n    var canvas = this.renderingContext.root.ownerDocument.defaultView;\n    this.eventService.setPickHandler(function (position) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var picked;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              return [4\n              /*yield*/\n              , this.renderingService.hooks.pick.promise({\n                position: position,\n                picked: [],\n                topmost: true // we only concern the topmost element\n\n              })];\n\n            case 1:\n              picked = _a.sent().picked;\n              return [2\n              /*return*/\n              , picked[0] || null];\n          }\n        });\n      });\n    });\n    renderingService.hooks.pointerWheel.tap(EventPlugin_1.tag, function (nativeEvent) {\n      var wheelEvent = _this.normalizeWheelEvent(nativeEvent);\n\n      _this.eventService.mapEvent(wheelEvent);\n    });\n    renderingService.hooks.pointerDown.tap(EventPlugin_1.tag, function (nativeEvent) {\n      var e_2, _a;\n\n      if (canvas.supportTouchEvent && nativeEvent.pointerType === 'touch') {\n        return;\n      }\n\n      var events = _this.normalizeToPointerEvent(nativeEvent, canvas);\n\n      if (_this.autoPreventDefault && events[0].isNormalized) {\n        var cancelable = nativeEvent.cancelable || !('cancelable' in nativeEvent);\n\n        if (cancelable) {\n          nativeEvent.preventDefault();\n        }\n      }\n\n      try {\n        for (var events_1 = __values(events), events_1_1 = events_1.next(); !events_1_1.done; events_1_1 = events_1.next()) {\n          var event_2 = events_1_1.value;\n\n          var federatedEvent = _this.bootstrapEvent(_this.rootPointerEvent, event_2, canvas);\n\n          _this.eventService.mapEvent(federatedEvent);\n        }\n      } catch (e_2_1) {\n        e_2 = {\n          error: e_2_1\n        };\n      } finally {\n        try {\n          if (events_1_1 && !events_1_1.done && (_a = events_1.return)) _a.call(events_1);\n        } finally {\n          if (e_2) throw e_2.error;\n        }\n      }\n\n      _this.setCursor(_this.eventService.cursor);\n    });\n    renderingService.hooks.pointerUp.tap(EventPlugin_1.tag, function (nativeEvent) {\n      var e_3, _a;\n\n      if (canvas.supportTouchEvent && nativeEvent.pointerType === 'touch') return; // account for element in SVG\n\n      var $element = _this.contextService.getDomElement();\n\n      var outside = $element && nativeEvent.target && nativeEvent.target !== $element && // @ts-ignore\n      $element.contains && // @ts-ignore\n      !$element.contains(nativeEvent.target) ? 'outside' : '';\n\n      var normalizedEvents = _this.normalizeToPointerEvent(nativeEvent, canvas);\n\n      try {\n        for (var normalizedEvents_2 = __values(normalizedEvents), normalizedEvents_2_1 = normalizedEvents_2.next(); !normalizedEvents_2_1.done; normalizedEvents_2_1 = normalizedEvents_2.next()) {\n          var normalizedEvent = normalizedEvents_2_1.value;\n\n          var event_3 = _this.bootstrapEvent(_this.rootPointerEvent, normalizedEvent, canvas);\n\n          event_3.type += outside;\n\n          _this.eventService.mapEvent(event_3);\n        }\n      } catch (e_3_1) {\n        e_3 = {\n          error: e_3_1\n        };\n      } finally {\n        try {\n          if (normalizedEvents_2_1 && !normalizedEvents_2_1.done && (_a = normalizedEvents_2.return)) _a.call(normalizedEvents_2);\n        } finally {\n          if (e_3) throw e_3.error;\n        }\n      }\n\n      _this.setCursor(_this.eventService.cursor);\n    });\n    renderingService.hooks.pointerMove.tap(EventPlugin_1.tag, this.onPointerMove);\n    renderingService.hooks.pointerOver.tap(EventPlugin_1.tag, this.onPointerMove);\n    renderingService.hooks.pointerOut.tap(EventPlugin_1.tag, this.onPointerMove);\n  };\n\n  EventPlugin.prototype.bootstrapEvent = function (event, nativeEvent, view) {\n    event.view = view;\n    event.originalEvent = null;\n    event.nativeEvent = nativeEvent;\n    event.pointerId = nativeEvent.pointerId;\n    event.width = nativeEvent.width;\n    event.height = nativeEvent.height;\n    event.isPrimary = nativeEvent.isPrimary;\n    event.pointerType = nativeEvent.pointerType;\n    event.pressure = nativeEvent.pressure;\n    event.tangentialPressure = nativeEvent.tangentialPressure;\n    event.tiltX = nativeEvent.tiltX;\n    event.tiltY = nativeEvent.tiltY;\n    event.twist = nativeEvent.twist;\n    this.transferMouseData(event, nativeEvent);\n\n    var _a = this.eventService.client2Viewport(new Point(nativeEvent.clientX, nativeEvent.clientY)),\n        x = _a.x,\n        y = _a.y;\n\n    event.viewport.x = x;\n    event.viewport.y = y;\n\n    var _b = this.eventService.viewport2Canvas(event.viewport),\n        canvasX = _b.x,\n        canvasY = _b.y;\n\n    event.canvas.x = canvasX;\n    event.canvas.y = canvasY;\n    event.global.copyFrom(event.canvas);\n    event.offset.copyFrom(event.canvas);\n    event.isTrusted = nativeEvent.isTrusted;\n\n    if (event.type === 'pointerleave') {\n      event.type = 'pointerout';\n    }\n\n    if (event.type.startsWith('mouse')) {\n      event.type = event.type.replace('mouse', 'pointer');\n    }\n\n    if (event.type.startsWith('touch')) {\n      event.type = TOUCH_TO_POINTER[event.type] || event.type;\n    }\n\n    return event;\n  };\n\n  EventPlugin.prototype.normalizeWheelEvent = function (nativeEvent) {\n    var event = this.rootWheelEvent;\n    this.transferMouseData(event, nativeEvent);\n    event.deltaMode = nativeEvent.deltaMode;\n    event.deltaX = nativeEvent.deltaX;\n    event.deltaY = nativeEvent.deltaY;\n    event.deltaZ = nativeEvent.deltaZ;\n\n    var _a = this.eventService.client2Viewport(new Point(nativeEvent.clientX, nativeEvent.clientY)),\n        x = _a.x,\n        y = _a.y;\n\n    event.viewport.x = x;\n    event.viewport.y = y;\n\n    var _b = this.eventService.viewport2Canvas(event.viewport),\n        canvasX = _b.x,\n        canvasY = _b.y;\n\n    event.canvas.x = canvasX;\n    event.canvas.y = canvasY;\n    event.global.copyFrom(event.canvas);\n    event.offset.copyFrom(event.canvas);\n    event.nativeEvent = nativeEvent;\n    event.type = nativeEvent.type;\n    return event;\n  };\n  /**\n   * Transfers base & mouse event data from the nativeEvent to the federated event.\n   */\n\n\n  EventPlugin.prototype.transferMouseData = function (event, nativeEvent) {\n    event.isTrusted = nativeEvent.isTrusted;\n    event.timeStamp = performance.now();\n    event.type = nativeEvent.type;\n    event.altKey = nativeEvent.altKey;\n    event.button = nativeEvent.button;\n    event.buttons = nativeEvent.buttons;\n    event.client.x = nativeEvent.clientX;\n    event.client.y = nativeEvent.clientY;\n    event.ctrlKey = nativeEvent.ctrlKey;\n    event.metaKey = nativeEvent.metaKey;\n    event.movement.x = nativeEvent.movementX;\n    event.movement.y = nativeEvent.movementY;\n    event.page.x = nativeEvent.pageX;\n    event.page.y = nativeEvent.pageY;\n    event.screen.x = nativeEvent.screenX;\n    event.screen.y = nativeEvent.screenY;\n    event.relatedTarget = null;\n  };\n\n  EventPlugin.prototype.setCursor = function (cursor) {\n    this.contextService.applyCursorStyle(cursor || this.canvasConfig.cursor || 'default');\n  };\n\n  EventPlugin.prototype.normalizeToPointerEvent = function (event, canvas) {\n    var normalizedEvents = [];\n\n    if (canvas.isTouchEvent(event)) {\n      for (var i = 0; i < event.changedTouches.length; i++) {\n        var touch = event.changedTouches[i]; // use changedTouches instead of touches since touchend has no touches\n        // @see https://stackoverflow.com/a/10079076\n\n        if (isUndefined(touch.button)) touch.button = event.touches.length ? 1 : 0;\n        if (isUndefined(touch.buttons)) touch.buttons = event.touches.length ? 1 : 0;\n\n        if (isUndefined(touch.isPrimary)) {\n          touch.isPrimary = event.touches.length === 1 && event.type === 'touchstart';\n        }\n\n        if (isUndefined(touch.width)) touch.width = touch.radiusX || 1;\n        if (isUndefined(touch.height)) touch.height = touch.radiusY || 1;\n        if (isUndefined(touch.tiltX)) touch.tiltX = 0;\n        if (isUndefined(touch.tiltY)) touch.tiltY = 0;\n        if (isUndefined(touch.pointerType)) touch.pointerType = 'touch'; // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Touch/identifier\n\n        if (isUndefined(touch.pointerId)) touch.pointerId = touch.identifier || 0;\n        if (isUndefined(touch.pressure)) touch.pressure = touch.force || 0.5;\n        if (isUndefined(touch.twist)) touch.twist = 0;\n        if (isUndefined(touch.tangentialPressure)) touch.tangentialPressure = 0;\n        touch.isNormalized = true;\n        touch.type = event.type; // ref to nativeEvent\n        // touch.nativeEvent = event;\n        // touch.isLast = event.changedTouches.length - 1 === i;\n\n        normalizedEvents.push(touch);\n      }\n    } else if (canvas.isMouseEvent(event)) {\n      var tempEvent = event;\n      if (isUndefined(tempEvent.isPrimary)) tempEvent.isPrimary = true;\n      if (isUndefined(tempEvent.width)) tempEvent.width = 1;\n      if (isUndefined(tempEvent.height)) tempEvent.height = 1;\n      if (isUndefined(tempEvent.tiltX)) tempEvent.tiltX = 0;\n      if (isUndefined(tempEvent.tiltY)) tempEvent.tiltY = 0;\n      if (isUndefined(tempEvent.pointerType)) tempEvent.pointerType = 'mouse';\n      if (isUndefined(tempEvent.pointerId)) tempEvent.pointerId = MOUSE_POINTER_ID;\n      if (isUndefined(tempEvent.pressure)) tempEvent.pressure = 0.5;\n      if (isUndefined(tempEvent.twist)) tempEvent.twist = 0;\n      if (isUndefined(tempEvent.tangentialPressure)) tempEvent.tangentialPressure = 0;\n      tempEvent.isNormalized = true;\n      normalizedEvents.push(tempEvent);\n    } else {\n      normalizedEvents.push(event);\n    }\n\n    return normalizedEvents;\n  };\n\n  var EventPlugin_1;\n  EventPlugin.tag = 'EventPlugin';\n\n  __decorate([inject(CanvasConfig), __metadata(\"design:type\", Object)], EventPlugin.prototype, \"canvasConfig\", void 0);\n\n  __decorate([inject(ContextService), __metadata(\"design:type\", Object)], EventPlugin.prototype, \"contextService\", void 0);\n\n  __decorate([inject(RenderingService), __metadata(\"design:type\", RenderingService)], EventPlugin.prototype, \"renderingService\", void 0);\n\n  __decorate([inject(RenderingContext), __metadata(\"design:type\", Object)], EventPlugin.prototype, \"renderingContext\", void 0);\n\n  __decorate([inject(EventService), __metadata(\"design:type\", EventService)], EventPlugin.prototype, \"eventService\", void 0);\n\n  EventPlugin = EventPlugin_1 = __decorate([singleton({\n    contrib: RenderingPluginContribution\n  })], EventPlugin);\n  return EventPlugin;\n}();\n\nexport { EventPlugin };","map":{"version":3,"sources":["/Users/dennis.zhang/Desktop/其它代码库/moa-flow/node_modules/@antv/g/es/plugins/EventPlugin.js"],"names":["__awaiter","__decorate","__generator","__metadata","__values","inject","singleton","isUndefined","FederatedPointerEvent","FederatedWheelEvent","RenderingContext","ContextService","RenderingService","EventService","RenderingPluginContribution","Point","CanvasConfig","MOUSE_POINTER_ID","TOUCH_TO_POINTER","EventPlugin","_this","autoPreventDefault","rootPointerEvent","rootWheelEvent","onPointerMove","nativeEvent","e_1","_a","_b","_c","canvas","renderingContext","root","ownerDocument","defaultView","supportTouchEvent","pointerType","normalizedEvents","normalizeToPointerEvent","normalizedEvents_1","normalizedEvents_1_1","next","done","normalizedEvent","value","event_1","bootstrapEvent","eventService","mapEvent","e_1_1","error","return","call","setCursor","cursor","EventPlugin_1","prototype","apply","renderingService","setPickHandler","position","picked","label","hooks","pick","promise","topmost","sent","pointerWheel","tap","tag","wheelEvent","normalizeWheelEvent","pointerDown","e_2","events","isNormalized","cancelable","preventDefault","events_1","events_1_1","event_2","federatedEvent","e_2_1","pointerUp","e_3","$element","contextService","getDomElement","outside","target","contains","normalizedEvents_2","normalizedEvents_2_1","event_3","type","e_3_1","pointerMove","pointerOver","pointerOut","event","view","originalEvent","pointerId","width","height","isPrimary","pressure","tangentialPressure","tiltX","tiltY","twist","transferMouseData","client2Viewport","clientX","clientY","x","y","viewport","viewport2Canvas","canvasX","canvasY","global","copyFrom","offset","isTrusted","startsWith","replace","deltaMode","deltaX","deltaY","deltaZ","timeStamp","performance","now","altKey","button","buttons","client","ctrlKey","metaKey","movement","movementX","movementY","page","pageX","pageY","screen","screenX","screenY","relatedTarget","applyCursorStyle","canvasConfig","isTouchEvent","i","changedTouches","length","touch","touches","radiusX","radiusY","identifier","force","push","isMouseEvent","tempEvent","Object","contrib"],"mappings":"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","sourcesContent":["import { __awaiter, __decorate, __generator, __metadata, __values } from \"tslib\";\nimport { inject, singleton } from 'mana-syringe';\nimport { isUndefined } from 'lodash-es';\nimport { FederatedPointerEvent } from '../dom/FederatedPointerEvent';\nimport { FederatedWheelEvent } from '../dom/FederatedWheelEvent';\nimport { RenderingContext } from '../services';\nimport { ContextService, RenderingService, EventService, RenderingPluginContribution } from '../services';\nimport { Point } from '../shapes';\nimport { CanvasConfig } from '../types';\nimport { MOUSE_POINTER_ID, TOUCH_TO_POINTER } from '../utils/event';\n/**\n * support mouse & touch events\n * @see https://github.com/pixijs/pixi.js/blob/dev/packages/interaction/README.md\n *\n * also provide some extra events such as `drag`\n */\n\nvar EventPlugin =\n/** @class */\nfunction () {\n  function EventPlugin() {\n    var _this = this;\n\n    this.autoPreventDefault = true;\n    this.rootPointerEvent = new FederatedPointerEvent(null);\n    this.rootWheelEvent = new FederatedWheelEvent(null);\n\n    this.onPointerMove = function (nativeEvent) {\n      var e_1, _a;\n\n      var _b, _c;\n\n      var canvas = (_c = (_b = _this.renderingContext.root) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.defaultView;\n      if (canvas.supportTouchEvent && nativeEvent.pointerType === 'touch') return;\n\n      var normalizedEvents = _this.normalizeToPointerEvent(nativeEvent, canvas);\n\n      try {\n        for (var normalizedEvents_1 = __values(normalizedEvents), normalizedEvents_1_1 = normalizedEvents_1.next(); !normalizedEvents_1_1.done; normalizedEvents_1_1 = normalizedEvents_1.next()) {\n          var normalizedEvent = normalizedEvents_1_1.value;\n\n          var event_1 = _this.bootstrapEvent(_this.rootPointerEvent, normalizedEvent, canvas);\n\n          _this.eventService.mapEvent(event_1);\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (normalizedEvents_1_1 && !normalizedEvents_1_1.done && (_a = normalizedEvents_1.return)) _a.call(normalizedEvents_1);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n\n      _this.setCursor(_this.eventService.cursor);\n    };\n  }\n\n  EventPlugin_1 = EventPlugin;\n\n  EventPlugin.prototype.apply = function (renderingService) {\n    var _this = this;\n\n    var canvas = this.renderingContext.root.ownerDocument.defaultView;\n    this.eventService.setPickHandler(function (position) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var picked;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              return [4\n              /*yield*/\n              , this.renderingService.hooks.pick.promise({\n                position: position,\n                picked: [],\n                topmost: true // we only concern the topmost element\n\n              })];\n\n            case 1:\n              picked = _a.sent().picked;\n              return [2\n              /*return*/\n              , picked[0] || null];\n          }\n        });\n      });\n    });\n    renderingService.hooks.pointerWheel.tap(EventPlugin_1.tag, function (nativeEvent) {\n      var wheelEvent = _this.normalizeWheelEvent(nativeEvent);\n\n      _this.eventService.mapEvent(wheelEvent);\n    });\n    renderingService.hooks.pointerDown.tap(EventPlugin_1.tag, function (nativeEvent) {\n      var e_2, _a;\n\n      if (canvas.supportTouchEvent && nativeEvent.pointerType === 'touch') {\n        return;\n      }\n\n      var events = _this.normalizeToPointerEvent(nativeEvent, canvas);\n\n      if (_this.autoPreventDefault && events[0].isNormalized) {\n        var cancelable = nativeEvent.cancelable || !('cancelable' in nativeEvent);\n\n        if (cancelable) {\n          nativeEvent.preventDefault();\n        }\n      }\n\n      try {\n        for (var events_1 = __values(events), events_1_1 = events_1.next(); !events_1_1.done; events_1_1 = events_1.next()) {\n          var event_2 = events_1_1.value;\n\n          var federatedEvent = _this.bootstrapEvent(_this.rootPointerEvent, event_2, canvas);\n\n          _this.eventService.mapEvent(federatedEvent);\n        }\n      } catch (e_2_1) {\n        e_2 = {\n          error: e_2_1\n        };\n      } finally {\n        try {\n          if (events_1_1 && !events_1_1.done && (_a = events_1.return)) _a.call(events_1);\n        } finally {\n          if (e_2) throw e_2.error;\n        }\n      }\n\n      _this.setCursor(_this.eventService.cursor);\n    });\n    renderingService.hooks.pointerUp.tap(EventPlugin_1.tag, function (nativeEvent) {\n      var e_3, _a;\n\n      if (canvas.supportTouchEvent && nativeEvent.pointerType === 'touch') return; // account for element in SVG\n\n      var $element = _this.contextService.getDomElement();\n\n      var outside = $element && nativeEvent.target && nativeEvent.target !== $element && // @ts-ignore\n      $element.contains && // @ts-ignore\n      !$element.contains(nativeEvent.target) ? 'outside' : '';\n\n      var normalizedEvents = _this.normalizeToPointerEvent(nativeEvent, canvas);\n\n      try {\n        for (var normalizedEvents_2 = __values(normalizedEvents), normalizedEvents_2_1 = normalizedEvents_2.next(); !normalizedEvents_2_1.done; normalizedEvents_2_1 = normalizedEvents_2.next()) {\n          var normalizedEvent = normalizedEvents_2_1.value;\n\n          var event_3 = _this.bootstrapEvent(_this.rootPointerEvent, normalizedEvent, canvas);\n\n          event_3.type += outside;\n\n          _this.eventService.mapEvent(event_3);\n        }\n      } catch (e_3_1) {\n        e_3 = {\n          error: e_3_1\n        };\n      } finally {\n        try {\n          if (normalizedEvents_2_1 && !normalizedEvents_2_1.done && (_a = normalizedEvents_2.return)) _a.call(normalizedEvents_2);\n        } finally {\n          if (e_3) throw e_3.error;\n        }\n      }\n\n      _this.setCursor(_this.eventService.cursor);\n    });\n    renderingService.hooks.pointerMove.tap(EventPlugin_1.tag, this.onPointerMove);\n    renderingService.hooks.pointerOver.tap(EventPlugin_1.tag, this.onPointerMove);\n    renderingService.hooks.pointerOut.tap(EventPlugin_1.tag, this.onPointerMove);\n  };\n\n  EventPlugin.prototype.bootstrapEvent = function (event, nativeEvent, view) {\n    event.view = view;\n    event.originalEvent = null;\n    event.nativeEvent = nativeEvent;\n    event.pointerId = nativeEvent.pointerId;\n    event.width = nativeEvent.width;\n    event.height = nativeEvent.height;\n    event.isPrimary = nativeEvent.isPrimary;\n    event.pointerType = nativeEvent.pointerType;\n    event.pressure = nativeEvent.pressure;\n    event.tangentialPressure = nativeEvent.tangentialPressure;\n    event.tiltX = nativeEvent.tiltX;\n    event.tiltY = nativeEvent.tiltY;\n    event.twist = nativeEvent.twist;\n    this.transferMouseData(event, nativeEvent);\n\n    var _a = this.eventService.client2Viewport(new Point(nativeEvent.clientX, nativeEvent.clientY)),\n        x = _a.x,\n        y = _a.y;\n\n    event.viewport.x = x;\n    event.viewport.y = y;\n\n    var _b = this.eventService.viewport2Canvas(event.viewport),\n        canvasX = _b.x,\n        canvasY = _b.y;\n\n    event.canvas.x = canvasX;\n    event.canvas.y = canvasY;\n    event.global.copyFrom(event.canvas);\n    event.offset.copyFrom(event.canvas);\n    event.isTrusted = nativeEvent.isTrusted;\n\n    if (event.type === 'pointerleave') {\n      event.type = 'pointerout';\n    }\n\n    if (event.type.startsWith('mouse')) {\n      event.type = event.type.replace('mouse', 'pointer');\n    }\n\n    if (event.type.startsWith('touch')) {\n      event.type = TOUCH_TO_POINTER[event.type] || event.type;\n    }\n\n    return event;\n  };\n\n  EventPlugin.prototype.normalizeWheelEvent = function (nativeEvent) {\n    var event = this.rootWheelEvent;\n    this.transferMouseData(event, nativeEvent);\n    event.deltaMode = nativeEvent.deltaMode;\n    event.deltaX = nativeEvent.deltaX;\n    event.deltaY = nativeEvent.deltaY;\n    event.deltaZ = nativeEvent.deltaZ;\n\n    var _a = this.eventService.client2Viewport(new Point(nativeEvent.clientX, nativeEvent.clientY)),\n        x = _a.x,\n        y = _a.y;\n\n    event.viewport.x = x;\n    event.viewport.y = y;\n\n    var _b = this.eventService.viewport2Canvas(event.viewport),\n        canvasX = _b.x,\n        canvasY = _b.y;\n\n    event.canvas.x = canvasX;\n    event.canvas.y = canvasY;\n    event.global.copyFrom(event.canvas);\n    event.offset.copyFrom(event.canvas);\n    event.nativeEvent = nativeEvent;\n    event.type = nativeEvent.type;\n    return event;\n  };\n  /**\n   * Transfers base & mouse event data from the nativeEvent to the federated event.\n   */\n\n\n  EventPlugin.prototype.transferMouseData = function (event, nativeEvent) {\n    event.isTrusted = nativeEvent.isTrusted;\n    event.timeStamp = performance.now();\n    event.type = nativeEvent.type;\n    event.altKey = nativeEvent.altKey;\n    event.button = nativeEvent.button;\n    event.buttons = nativeEvent.buttons;\n    event.client.x = nativeEvent.clientX;\n    event.client.y = nativeEvent.clientY;\n    event.ctrlKey = nativeEvent.ctrlKey;\n    event.metaKey = nativeEvent.metaKey;\n    event.movement.x = nativeEvent.movementX;\n    event.movement.y = nativeEvent.movementY;\n    event.page.x = nativeEvent.pageX;\n    event.page.y = nativeEvent.pageY;\n    event.screen.x = nativeEvent.screenX;\n    event.screen.y = nativeEvent.screenY;\n    event.relatedTarget = null;\n  };\n\n  EventPlugin.prototype.setCursor = function (cursor) {\n    this.contextService.applyCursorStyle(cursor || this.canvasConfig.cursor || 'default');\n  };\n\n  EventPlugin.prototype.normalizeToPointerEvent = function (event, canvas) {\n    var normalizedEvents = [];\n\n    if (canvas.isTouchEvent(event)) {\n      for (var i = 0; i < event.changedTouches.length; i++) {\n        var touch = event.changedTouches[i]; // use changedTouches instead of touches since touchend has no touches\n        // @see https://stackoverflow.com/a/10079076\n\n        if (isUndefined(touch.button)) touch.button = event.touches.length ? 1 : 0;\n        if (isUndefined(touch.buttons)) touch.buttons = event.touches.length ? 1 : 0;\n\n        if (isUndefined(touch.isPrimary)) {\n          touch.isPrimary = event.touches.length === 1 && event.type === 'touchstart';\n        }\n\n        if (isUndefined(touch.width)) touch.width = touch.radiusX || 1;\n        if (isUndefined(touch.height)) touch.height = touch.radiusY || 1;\n        if (isUndefined(touch.tiltX)) touch.tiltX = 0;\n        if (isUndefined(touch.tiltY)) touch.tiltY = 0;\n        if (isUndefined(touch.pointerType)) touch.pointerType = 'touch'; // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Touch/identifier\n\n        if (isUndefined(touch.pointerId)) touch.pointerId = touch.identifier || 0;\n        if (isUndefined(touch.pressure)) touch.pressure = touch.force || 0.5;\n        if (isUndefined(touch.twist)) touch.twist = 0;\n        if (isUndefined(touch.tangentialPressure)) touch.tangentialPressure = 0;\n        touch.isNormalized = true;\n        touch.type = event.type; // ref to nativeEvent\n        // touch.nativeEvent = event;\n        // touch.isLast = event.changedTouches.length - 1 === i;\n\n        normalizedEvents.push(touch);\n      }\n    } else if (canvas.isMouseEvent(event)) {\n      var tempEvent = event;\n      if (isUndefined(tempEvent.isPrimary)) tempEvent.isPrimary = true;\n      if (isUndefined(tempEvent.width)) tempEvent.width = 1;\n      if (isUndefined(tempEvent.height)) tempEvent.height = 1;\n      if (isUndefined(tempEvent.tiltX)) tempEvent.tiltX = 0;\n      if (isUndefined(tempEvent.tiltY)) tempEvent.tiltY = 0;\n      if (isUndefined(tempEvent.pointerType)) tempEvent.pointerType = 'mouse';\n      if (isUndefined(tempEvent.pointerId)) tempEvent.pointerId = MOUSE_POINTER_ID;\n      if (isUndefined(tempEvent.pressure)) tempEvent.pressure = 0.5;\n      if (isUndefined(tempEvent.twist)) tempEvent.twist = 0;\n      if (isUndefined(tempEvent.tangentialPressure)) tempEvent.tangentialPressure = 0;\n      tempEvent.isNormalized = true;\n      normalizedEvents.push(tempEvent);\n    } else {\n      normalizedEvents.push(event);\n    }\n\n    return normalizedEvents;\n  };\n\n  var EventPlugin_1;\n  EventPlugin.tag = 'EventPlugin';\n\n  __decorate([inject(CanvasConfig), __metadata(\"design:type\", Object)], EventPlugin.prototype, \"canvasConfig\", void 0);\n\n  __decorate([inject(ContextService), __metadata(\"design:type\", Object)], EventPlugin.prototype, \"contextService\", void 0);\n\n  __decorate([inject(RenderingService), __metadata(\"design:type\", RenderingService)], EventPlugin.prototype, \"renderingService\", void 0);\n\n  __decorate([inject(RenderingContext), __metadata(\"design:type\", Object)], EventPlugin.prototype, \"renderingContext\", void 0);\n\n  __decorate([inject(EventService), __metadata(\"design:type\", EventService)], EventPlugin.prototype, \"eventService\", void 0);\n\n  EventPlugin = EventPlugin_1 = __decorate([singleton({\n    contrib: RenderingPluginContribution\n  })], EventPlugin);\n  return EventPlugin;\n}();\n\nexport { EventPlugin };"]},"metadata":{},"sourceType":"module"}