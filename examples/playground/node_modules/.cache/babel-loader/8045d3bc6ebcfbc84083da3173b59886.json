{"ast":null,"code":"import { __spreadArray } from './node_modules/tslib/tslib.es6.js';\nimport { autorun } from 'mobx';\nimport './node_modules/lodash/lodash.js';\nimport { EVT_LEFTCLICK, STAGE_ID, EVT_RIGHTCLICK } from './constants.js';\nimport { l as lodash } from './_virtual/lodash.js';\n\nvar initClearState = function (model, stage) {\n  stage.on('mousedown', function (e) {\n    if (e.button === EVT_LEFTCLICK) {\n      model.buffer.rightClickPanel.visible = false;\n    }\n\n    if (!model.buffer.select.isSelecting && e.button === EVT_LEFTCLICK) model.clearSelect();\n  });\n};\n\nvar initLink = function (model, stage) {\n  stage.on('mouseup', function (e) {\n    model.clearLinkBuffer();\n  });\n  stage.on('mousemove', function (e) {\n    var link = model.buffer.link;\n    if (!link.source) return;\n    model.setLinkingPosition(e);\n  });\n};\n\nvar initSelect = function (model) {\n  // 非受控设置select的节点\n  var prevSelectCells = [];\n  autorun(function () {\n    // 上次存在这次不存在的就是需要设置为false的\n    var toFalseCells = lodash.exports.without.apply(void 0, __spreadArray([prevSelectCells], model.selectCells, false)); // 这次存在上次不存在的就是需要设置为true的\n\n    var toTrueCells = lodash.exports.without.apply(void 0, __spreadArray([model.selectCells], prevSelectCells, false));\n    toFalseCells.forEach(function (cellId) {\n      var cellData = model.getCellData(cellId);\n      cellData && (cellData.$state.isSelect = false);\n    });\n    toTrueCells.forEach(function (cellId) {\n      var cellData = model.getCellData(cellId);\n      cellData && (cellData.$state.isSelect = true);\n    });\n    prevSelectCells = model.selectCells.slice();\n  });\n};\n\nvar initDrag = function (model, stage) {\n  var _a = model.buffer,\n      drag = _a.drag,\n      select = _a.select; // 移动整个stage\n\n  stage.on('mousemove', function (e) {\n    var movement = {\n      x: e.canvas.x - drag.start.x,\n      y: e.canvas.y - drag.start.y\n    };\n\n    if (model.hotKey[\"Space\"] && model.hotKey['LeftMouseDown']) {\n      // stage并不受scale的影响，不用处理\n      model.setStagePosition(model.x() + movement.x, model.y() + movement.y);\n    }\n\n    if (select.isSelecting) {\n      // if (stage.isListening()) stage.listening(false);\n      model.selectCells.forEach(function (id) {\n        var cellData = model.getCellData(id);\n\n        if (cellData.cellType === 'node') {\n          model.setCellData(cellData.id, {\n            x: cellData.x + movement.x / model.scale(),\n            y: cellData.y + movement.y / model.scale()\n          });\n        }\n      });\n    }\n\n    drag.start.x = e.canvas.x;\n    drag.start.y = e.canvas.y;\n  });\n  stage.on('mouseup', function () {\n    if (select.isSelecting) {\n      model.selectCells.forEach(function (id) {\n        var cellData = model.getCellData(id);\n\n        if (cellData.cellType === 'node') {\n          if (model.grid) model.setCellData(cellData.id, model.snap({\n            x: cellData.x,\n            y: cellData.y\n          }));\n        }\n      });\n      select.isSelecting = false;\n    }\n  });\n};\n\nvar initScale = function (model, stage) {\n  var _a;\n\n  var scaleBy = 1.02;\n  (_a = document.querySelector(\"#\".concat(STAGE_ID))) === null || _a === void 0 ? void 0 : _a.addEventListener('wheel', function (e) {\n    e.preventDefault();\n  });\n  stage.on('wheel', function (e) {\n    // stop default scrolling\n    e.stopPropagation();\n    var oldScale = model.canvasData.scale;\n    var pointer = e.canvas;\n    var mousePointTo = {\n      x: (pointer.x - model.x()) / oldScale,\n      y: (pointer.y - model.y()) / oldScale\n    }; // how to scale? Zoom in? Or zoom out?\n\n    var direction = e.deltaY > 0 ? 1 : -1; // in that case lets revert direction\n\n    if (e.ctrlKey) {\n      direction = -direction;\n    }\n\n    var newScale = direction > 0 ? oldScale * scaleBy : oldScale / scaleBy;\n    model.setStageScale(newScale);\n    var newPos = {\n      x: pointer.x - mousePointTo.x * newScale,\n      y: pointer.y - mousePointTo.y * newScale\n    };\n    model.setStagePosition(newPos.x, newPos.y);\n  });\n};\n\nvar initMultiSelect = function (model, stage) {\n  if (model.hotKey['Space']) return; // 设置多选矩形框起始点\n\n  stage.on('mousedown', function (e) {\n    if (model.buffer.select.isSelecting) return;\n\n    if (!model.hotKey[\"Space\"] && e.button === EVT_LEFTCLICK) {\n      var pos = model.getStageCursor(e);\n      model.setMultiSelect({\n        start: {\n          x: pos.x,\n          y: pos.y\n        },\n        end: {\n          x: pos.x,\n          y: pos.y\n        }\n      });\n    }\n  }); // 矩形多选框 鼠标up时\n\n  stage.on('mouseup', function (e) {\n    if (model.buffer.select.isSelecting) return;\n    var pos = model.getStageCursor(e);\n    model.setMultiSelect({\n      start: {\n        x: pos.x,\n        y: pos.y\n      },\n      end: {\n        x: pos.x,\n        y: pos.y\n      }\n    }, true);\n  }); // 动态设置多选矩形框大小\n\n  stage.on('mousemove', function (e) {\n    if (model.buffer.select.isSelecting) return;\n\n    if (!model.hotKey[\"Space\"] && model.hotKey[\"LeftMouseDown\"]) {\n      var pos = model.getStageCursor(e);\n      model.setMultiSelect({\n        end: {\n          x: pos.x,\n          y: pos.y\n        }\n      });\n    }\n  });\n};\n\nvar initHotKeys = function (model, stage) {\n  stage.on('mousedown', function (e) {\n    e.preventDefault();\n\n    switch (e.button) {\n      case EVT_LEFTCLICK:\n        model.setHotKey('LeftMouseDown', true);\n        break;\n\n      case EVT_RIGHTCLICK:\n        model.setHotKey('RightMouseDown', true);\n    }\n  });\n  stage.on('mouseup', function (e) {\n    switch (e.button) {\n      case EVT_LEFTCLICK:\n        model.setHotKey('LeftMouseDown', false);\n    }\n  });\n  window.addEventListener('keydown', function (e) {\n    switch (e.code) {\n      case 'Space':\n        e.preventDefault();\n        model.setHotKey(e.code, true);\n    }\n  });\n  window.addEventListener('keyup', function (e) {\n    console.log(e.code);\n\n    switch (e.code) {\n      case 'Space':\n        e.preventDefault();\n        model.setHotKey(e.code, false);\n    }\n  });\n};\n\nexport { initClearState, initDrag, initHotKeys, initLink, initMultiSelect, initScale, initSelect };","map":{"version":3,"sources":["/Users/dennis.zhang/Desktop/其它代码库/moa-flow/packages/flow/lib/events.js"],"names":["__spreadArray","autorun","EVT_LEFTCLICK","STAGE_ID","EVT_RIGHTCLICK","l","lodash","initClearState","model","stage","on","e","button","buffer","rightClickPanel","visible","select","isSelecting","clearSelect","initLink","clearLinkBuffer","link","source","setLinkingPosition","initSelect","prevSelectCells","toFalseCells","exports","without","apply","selectCells","toTrueCells","forEach","cellId","cellData","getCellData","$state","isSelect","slice","initDrag","_a","drag","movement","x","canvas","start","y","hotKey","setStagePosition","id","cellType","setCellData","scale","grid","snap","initScale","scaleBy","document","querySelector","concat","addEventListener","preventDefault","stopPropagation","oldScale","canvasData","pointer","mousePointTo","direction","deltaY","ctrlKey","newScale","setStageScale","newPos","initMultiSelect","pos","getStageCursor","setMultiSelect","end","initHotKeys","setHotKey","window","code","console","log"],"mappings":"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","sourcesContent":["import { __spreadArray } from './node_modules/tslib/tslib.es6.js';\nimport { autorun } from 'mobx';\nimport './node_modules/lodash/lodash.js';\nimport { EVT_LEFTCLICK, STAGE_ID, EVT_RIGHTCLICK } from './constants.js';\nimport { l as lodash } from './_virtual/lodash.js';\n\nvar initClearState = function (model, stage) {\n    stage.on('mousedown', function (e) {\n        if (e.button === EVT_LEFTCLICK) {\n            model.buffer.rightClickPanel.visible = false;\n        }\n        if (!model.buffer.select.isSelecting && e.button === EVT_LEFTCLICK)\n            model.clearSelect();\n    });\n};\nvar initLink = function (model, stage) {\n    stage.on('mouseup', function (e) {\n        model.clearLinkBuffer();\n    });\n    stage.on('mousemove', function (e) {\n        var link = model.buffer.link;\n        if (!link.source)\n            return;\n        model.setLinkingPosition(e);\n    });\n};\nvar initSelect = function (model) {\n    // 非受控设置select的节点\n    var prevSelectCells = [];\n    autorun(function () {\n        // 上次存在这次不存在的就是需要设置为false的\n        var toFalseCells = lodash.exports.without.apply(void 0, __spreadArray([prevSelectCells], model.selectCells, false));\n        // 这次存在上次不存在的就是需要设置为true的\n        var toTrueCells = lodash.exports.without.apply(void 0, __spreadArray([model.selectCells], prevSelectCells, false));\n        toFalseCells.forEach(function (cellId) {\n            var cellData = model.getCellData(cellId);\n            cellData && (cellData.$state.isSelect = false);\n        });\n        toTrueCells.forEach(function (cellId) {\n            var cellData = model.getCellData(cellId);\n            cellData && (cellData.$state.isSelect = true);\n        });\n        prevSelectCells = model.selectCells.slice();\n    });\n};\nvar initDrag = function (model, stage) {\n    var _a = model.buffer, drag = _a.drag, select = _a.select;\n    // 移动整个stage\n    stage.on('mousemove', function (e) {\n        var movement = {\n            x: (e.canvas.x - drag.start.x),\n            y: (e.canvas.y - drag.start.y)\n        };\n        if (model.hotKey[\"Space\"] && model.hotKey['LeftMouseDown']) {\n            // stage并不受scale的影响，不用处理\n            model.setStagePosition(model.x() + movement.x, model.y() + movement.y);\n        }\n        if (select.isSelecting) {\n            // if (stage.isListening()) stage.listening(false);\n            model.selectCells.forEach(function (id) {\n                var cellData = model.getCellData(id);\n                if (cellData.cellType === 'node') {\n                    model.setCellData(cellData.id, {\n                        x: cellData.x + movement.x / model.scale(),\n                        y: cellData.y + movement.y / model.scale(),\n                    });\n                }\n            });\n        }\n        drag.start.x = e.canvas.x;\n        drag.start.y = e.canvas.y;\n    });\n    stage.on('mouseup', function () {\n        if (select.isSelecting) {\n            model.selectCells.forEach(function (id) {\n                var cellData = model.getCellData(id);\n                if (cellData.cellType === 'node') {\n                    if (model.grid)\n                        model.setCellData(cellData.id, model.snap({\n                            x: cellData.x,\n                            y: cellData.y\n                        }));\n                }\n            });\n            select.isSelecting = false;\n        }\n    });\n};\nvar initScale = function (model, stage) {\n    var _a;\n    var scaleBy = 1.02;\n    (_a = document.querySelector(\"#\".concat(STAGE_ID))) === null || _a === void 0 ? void 0 : _a.addEventListener('wheel', function (e) {\n        e.preventDefault();\n    });\n    stage.on('wheel', function (e) {\n        // stop default scrolling\n        e.stopPropagation();\n        var oldScale = model.canvasData.scale;\n        var pointer = e.canvas;\n        var mousePointTo = {\n            x: (pointer.x - model.x()) / oldScale,\n            y: (pointer.y - model.y()) / oldScale,\n        };\n        // how to scale? Zoom in? Or zoom out?\n        var direction = e.deltaY > 0 ? 1 : -1;\n        // in that case lets revert direction\n        if (e.ctrlKey) {\n            direction = -direction;\n        }\n        var newScale = direction > 0 ? oldScale * scaleBy : oldScale / scaleBy;\n        model.setStageScale(newScale);\n        var newPos = {\n            x: pointer.x - mousePointTo.x * newScale,\n            y: pointer.y - mousePointTo.y * newScale,\n        };\n        model.setStagePosition(newPos.x, newPos.y);\n    });\n};\nvar initMultiSelect = function (model, stage) {\n    if (model.hotKey['Space'])\n        return;\n    // 设置多选矩形框起始点\n    stage.on('mousedown', function (e) {\n        if (model.buffer.select.isSelecting)\n            return;\n        if (!model.hotKey[\"Space\"] && e.button === EVT_LEFTCLICK) {\n            var pos = model.getStageCursor(e);\n            model.setMultiSelect({\n                start: {\n                    x: pos.x,\n                    y: pos.y,\n                },\n                end: {\n                    x: pos.x,\n                    y: pos.y,\n                },\n            });\n        }\n    });\n    // 矩形多选框 鼠标up时\n    stage.on('mouseup', function (e) {\n        if (model.buffer.select.isSelecting)\n            return;\n        var pos = model.getStageCursor(e);\n        model.setMultiSelect({\n            start: {\n                x: pos.x,\n                y: pos.y,\n            },\n            end: {\n                x: pos.x,\n                y: pos.y,\n            },\n        }, true);\n    });\n    // 动态设置多选矩形框大小\n    stage.on('mousemove', function (e) {\n        if (model.buffer.select.isSelecting)\n            return;\n        if (!model.hotKey[\"Space\"] && model.hotKey[\"LeftMouseDown\"]) {\n            var pos = model.getStageCursor(e);\n            model.setMultiSelect({\n                end: {\n                    x: pos.x,\n                    y: pos.y,\n                },\n            });\n        }\n    });\n};\nvar initHotKeys = function (model, stage) {\n    stage.on('mousedown', function (e) {\n        e.preventDefault();\n        switch (e.button) {\n            case EVT_LEFTCLICK:\n                model.setHotKey('LeftMouseDown', true);\n                break;\n            case EVT_RIGHTCLICK: model.setHotKey('RightMouseDown', true);\n        }\n    });\n    stage.on('mouseup', function (e) {\n        switch (e.button) {\n            case EVT_LEFTCLICK: model.setHotKey('LeftMouseDown', false);\n        }\n    });\n    window.addEventListener('keydown', function (e) {\n        switch (e.code) {\n            case 'Space':\n                e.preventDefault();\n                model.setHotKey(e.code, true);\n        }\n    });\n    window.addEventListener('keyup', function (e) {\n        console.log(e.code);\n        switch (e.code) {\n            case 'Space':\n                e.preventDefault();\n                model.setHotKey(e.code, false);\n        }\n    });\n};\n\nexport { initClearState, initDrag, initHotKeys, initLink, initMultiSelect, initScale, initSelect };\n"]},"metadata":{},"sourceType":"module"}