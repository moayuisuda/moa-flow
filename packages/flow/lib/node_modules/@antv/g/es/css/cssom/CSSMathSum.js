import { __extends, __assign } from '../../../../../tslib/tslib.es6.js';
import { DCHECK } from '../../utils/assert.js';
import '../../../../../inversify/lib/inversify.js';
import '../../../../../mana-syringe/es/core.js';
import '../../../../../mana-syringe/es/inversify/index.js';
import '../../../../../mana-syringe/es/container.js';
import '../../../../../mana-syringe/es/contribution/contribution-protocol.js';
import '../../../../../mana-syringe/es/register.js';
import '../../../../../mana-syringe/es/contribution/index.js';
import { ParenLess, Nested } from './types.js';
import './CSSColorValue.js';
import './CSSKeywordValue.js';
import './CSSMathOperator.js';
import './CSSMathInvert.js';
import './CSSMathMax.js';
import './CSSMathMin.js';
import './CSSMathNegate.js';
import './CSSMathProduct.js';
import './CSSMathValue.js';
import { typeCheck, CSSMathVariadic } from './CSSMathVariadic.js';
import './CSSNumericValue.js';
import { CSSNumericValueType } from './CSSNumericValueType.js';
import './CSSRGB.js';
import './CSSGradientValue.js';
import { CSSStyleValueType } from './CSSStyleValue.js';
import './CSSTransformValue.js';
import './CSSTranslate.js';
import './CSSUnitValue.js';
import '../parser/dimension.js';
import '../../types.js';
import '../../shapes/Rectangle.js';
import '../parser/filter.js';
import '../parser/transform.js';
import '../properties/CSSPropertyLengthOrPercentage.js';
import '../properties/CSSPropertyLocalPosition.js';
import '../properties/CSSPropertyOpacity.js';
import '../properties/CSSPropertyColor.js';
import '../properties/CSSPropertyFilter.js';
import '../properties/CSSPropertyLineDash.js';
import '../properties/CSSPropertyShadowBlur.js';
import '../properties/CSSPropertyOffsetPath.js';
import '../properties/CSSPropertyOffsetDistance.js';
import '../properties/CSSPropertyAnchor.js';
import '../properties/CSSPropertyZIndex.js';
import '../properties/CSSPropertyTransform.js';
import '../properties/CSSPropertyTransformOrigin.js';
import '../properties/CSSPropertyPath.js';
import '../properties/CSSPropertyPoints.js';
import '../properties/CSSPropertyClipPath.js';
import '../properties/CSSPropertyText.js';
import '../properties/CSSPropertyTextTransform.js';
import '../StyleValueRegistry.js';
import '../LayoutRegistry.js';
import '../../utils/custom-easing.js';

/**
 * Represents the sum of one or more CSSNumericValues.
 * @see https://drafts.css-houdini.org/css-typed-om/#cssmathsum
 */

var CSSMathSum =
/** @class */
function (_super) {
  __extends(CSSMathSum, _super);

  function CSSMathSum() {
    var _this = _super !== null && _super.apply(this, arguments) || this;

    _this.operator = 'sum';
    return _this;
  }

  CSSMathSum.create = function (values) {
    var error = false;
    var finalType = typeCheck(values, CSSNumericValueType.add, error);
    return error ? null : new CSSMathSum(values, finalType);
  };

  CSSMathSum.numericTypeFromUnitMap = function (units) {
    var type = new CSSNumericValueType();
    Object.keys(units).forEach(function (key) {
      var exp = units[key];
      var error = false;
      type = CSSNumericValueType.multiply(type, new CSSNumericValueType(Number(key), exp), error);
      DCHECK(!error);
    });
    return type;
  };

  CSSMathSum.canCreateNumericTypeFromSumValue = function (sum) {
    var _this = this;

    DCHECK(!!sum.length);
    var first_type = this.numericTypeFromUnitMap(sum[0].units);
    return sum.every(function (term) {
      var error = false;
      CSSNumericValueType.add(first_type, _this.numericTypeFromUnitMap(term.units), error);
      return !error;
    });
  };

  CSSMathSum.prototype.clone = function () {
    return new CSSMathSum(this.values, this.type_);
  };

  CSSMathSum.prototype.getType = function () {
    return CSSStyleValueType.kSumType;
  }; // toCalcExpressionNode() {
  //   return this.toCalcExporessionNodeForVariadic(CSSMathOperator.kAdd);
  // }


  CSSMathSum.prototype.sumValue = function () {
    var sum = [];
    this.numericValues().forEach(function (value) {
      var child_sum = value.sumValue();

      if (!child_sum.length) {
        return null;
      }

      child_sum.forEach(function (term) {
        var index = sum.findIndex(function (s) {
          return JSON.stringify(s.units) === JSON.stringify(term.units);
        });

        if (index === -1) {
          sum.push(__assign({}, term));
        } else {
          sum[index].value += term.value;
        }
      });
    });
    if (!CSSMathSum.canCreateNumericTypeFromSumValue(sum)) return null;
    return sum;
  };

  CSSMathSum.prototype.buildCSSText = function (nested, paren_less, result) {
    if (paren_less == ParenLess.kNo) {
      result += nested === Nested.kYes ? '(' : 'calc(';
    }

    var values = this.numericValues();
    result = values[0].buildCSSText(Nested.kYes, ParenLess.kNo, result);

    for (var i = 1; i < values.length; i++) {
      var arg = values[i];

      if (arg.getType() === CSSStyleValueType.kNegateType) {
        result += ' - ';
        result = arg.value.buildCSSText(Nested.kYes, ParenLess.kNo, result);
      } else {
        result += ' + ';
        result = arg.buildCSSText(Nested.kYes, ParenLess.kNo, result);
      }
    }

    if (paren_less === ParenLess.kNo) {
      result += ')';
    }

    return result;
  };

  return CSSMathSum;
}(CSSMathVariadic);

export { CSSMathSum };
